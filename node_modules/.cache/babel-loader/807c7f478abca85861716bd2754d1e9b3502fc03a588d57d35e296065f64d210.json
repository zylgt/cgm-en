{"ast":null,"code":"\"use strict\";\n\nvar __createBinding = this && this.__createBinding || (Object.create ? function (o, m, k, k2) {\n  if (k2 === undefined) k2 = k;\n  var desc = Object.getOwnPropertyDescriptor(m, k);\n  if (!desc || (\"get\" in desc ? !m.__esModule : desc.writable || desc.configurable)) {\n    desc = {\n      enumerable: true,\n      get: function () {\n        return m[k];\n      }\n    };\n  }\n  Object.defineProperty(o, k2, desc);\n} : function (o, m, k, k2) {\n  if (k2 === undefined) k2 = k;\n  o[k2] = m[k];\n});\nvar __setModuleDefault = this && this.__setModuleDefault || (Object.create ? function (o, v) {\n  Object.defineProperty(o, \"default\", {\n    enumerable: true,\n    value: v\n  });\n} : function (o, v) {\n  o[\"default\"] = v;\n});\nvar __importStar = this && this.__importStar || function (mod) {\n  if (mod && mod.__esModule) return mod;\n  var result = {};\n  if (mod != null) for (var k in mod) if (k !== \"default\" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);\n  __setModuleDefault(result, mod);\n  return result;\n};\nvar __importDefault = this && this.__importDefault || function (mod) {\n  return mod && mod.__esModule ? mod : {\n    \"default\": mod\n  };\n};\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.ProxyAgent = exports.proxies = void 0;\nconst http = __importStar(require(\"http\"));\nconst https = __importStar(require(\"https\"));\nconst url_1 = require(\"url\");\nconst lru_cache_1 = __importDefault(require(\"lru-cache\"));\nconst agent_base_1 = require(\"agent-base\");\nconst debug_1 = __importDefault(require(\"debug\"));\nconst proxy_from_env_1 = require(\"proxy-from-env\");\nconst pac_proxy_agent_1 = require(\"pac-proxy-agent\");\nconst http_proxy_agent_1 = require(\"http-proxy-agent\");\nconst https_proxy_agent_1 = require(\"https-proxy-agent\");\nconst socks_proxy_agent_1 = require(\"socks-proxy-agent\");\nconst debug = (0, debug_1.default)('proxy-agent');\nconst PROTOCOLS = [...http_proxy_agent_1.HttpProxyAgent.protocols, ...socks_proxy_agent_1.SocksProxyAgent.protocols, ...pac_proxy_agent_1.PacProxyAgent.protocols];\n/**\n * Supported proxy types.\n */\nexports.proxies = {\n  http: [http_proxy_agent_1.HttpProxyAgent, https_proxy_agent_1.HttpsProxyAgent],\n  https: [http_proxy_agent_1.HttpProxyAgent, https_proxy_agent_1.HttpsProxyAgent],\n  socks: [socks_proxy_agent_1.SocksProxyAgent, socks_proxy_agent_1.SocksProxyAgent],\n  socks4: [socks_proxy_agent_1.SocksProxyAgent, socks_proxy_agent_1.SocksProxyAgent],\n  socks4a: [socks_proxy_agent_1.SocksProxyAgent, socks_proxy_agent_1.SocksProxyAgent],\n  socks5: [socks_proxy_agent_1.SocksProxyAgent, socks_proxy_agent_1.SocksProxyAgent],\n  socks5h: [socks_proxy_agent_1.SocksProxyAgent, socks_proxy_agent_1.SocksProxyAgent],\n  'pac+data': [pac_proxy_agent_1.PacProxyAgent, pac_proxy_agent_1.PacProxyAgent],\n  'pac+file': [pac_proxy_agent_1.PacProxyAgent, pac_proxy_agent_1.PacProxyAgent],\n  'pac+ftp': [pac_proxy_agent_1.PacProxyAgent, pac_proxy_agent_1.PacProxyAgent],\n  'pac+http': [pac_proxy_agent_1.PacProxyAgent, pac_proxy_agent_1.PacProxyAgent],\n  'pac+https': [pac_proxy_agent_1.PacProxyAgent, pac_proxy_agent_1.PacProxyAgent]\n};\nfunction isValidProtocol(v) {\n  return PROTOCOLS.includes(v);\n}\n/**\n * Uses the appropriate `Agent` subclass based off of the \"proxy\"\n * environment variables that are currently set.\n *\n * An LRU cache is used, to prevent unnecessary creation of proxy\n * `http.Agent` instances.\n */\nclass ProxyAgent extends agent_base_1.Agent {\n  constructor(opts) {\n    super(opts);\n    /**\n     * Cache for `Agent` instances.\n     */\n    this.cache = new lru_cache_1.default({\n      max: 20\n    });\n    debug('Creating new ProxyAgent instance: %o', opts);\n    this.connectOpts = opts;\n    this.httpAgent = opts?.httpAgent || new http.Agent(opts);\n    this.httpsAgent = opts?.httpsAgent || new https.Agent(opts);\n    this.getProxyForUrl = opts?.getProxyForUrl || proxy_from_env_1.getProxyForUrl;\n  }\n  async connect(req, opts) {\n    const {\n      secureEndpoint\n    } = opts;\n    const isWebSocket = req.getHeader('upgrade') === 'websocket';\n    const protocol = secureEndpoint ? isWebSocket ? 'wss:' : 'https:' : isWebSocket ? 'ws:' : 'http:';\n    const host = req.getHeader('host');\n    const url = new url_1.URL(req.path, `${protocol}//${host}`).href;\n    const proxy = await this.getProxyForUrl(url);\n    if (!proxy) {\n      debug('Proxy not enabled for URL: %o', url);\n      return secureEndpoint ? this.httpsAgent : this.httpAgent;\n    }\n    debug('Request URL: %o', url);\n    debug('Proxy URL: %o', proxy);\n    // attempt to get a cached `http.Agent` instance first\n    const cacheKey = `${protocol}+${proxy}`;\n    let agent = this.cache.get(cacheKey);\n    if (!agent) {\n      const proxyUrl = new url_1.URL(proxy);\n      const proxyProto = proxyUrl.protocol.replace(':', '');\n      if (!isValidProtocol(proxyProto)) {\n        throw new Error(`Unsupported protocol for proxy URL: ${proxy}`);\n      }\n      const ctor = exports.proxies[proxyProto][secureEndpoint || isWebSocket ? 1 : 0];\n      // @ts-expect-error mehâ€¦\n      agent = new ctor(proxy, this.connectOpts);\n      this.cache.set(cacheKey, agent);\n    } else {\n      debug('Cache hit for proxy URL: %o', proxy);\n    }\n    return agent;\n  }\n  destroy() {\n    for (const agent of this.cache.values()) {\n      agent.destroy();\n    }\n    super.destroy();\n  }\n}\nexports.ProxyAgent = ProxyAgent;","map":{"version":3,"names":["http","__importStar","require","https","url_1","lru_cache_1","__importDefault","agent_base_1","debug_1","proxy_from_env_1","pac_proxy_agent_1","http_proxy_agent_1","https_proxy_agent_1","socks_proxy_agent_1","debug","default","PROTOCOLS","HttpProxyAgent","protocols","SocksProxyAgent","PacProxyAgent","exports","proxies","HttpsProxyAgent","socks","socks4","socks4a","socks5","socks5h","isValidProtocol","v","includes","ProxyAgent","Agent","constructor","opts","cache","max","connectOpts","httpAgent","httpsAgent","getProxyForUrl","connect","req","secureEndpoint","isWebSocket","getHeader","protocol","host","url","URL","path","href","proxy","cacheKey","agent","get","proxyUrl","proxyProto","replace","Error","ctor","set","destroy","values"],"sources":["../src/index.ts"],"sourcesContent":[null],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"script","externalDependencies":[]}