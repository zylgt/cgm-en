{"ast":null,"code":"\"use strict\";\n\n/**\n * @license\n * Copyright 2023 Google Inc.\n * SPDX-License-Identifier: Apache-2.0\n */\nrequire(\"core-js/modules/es.array.push.js\");\nvar __importDefault = this && this.__importDefault || function (mod) {\n  return mod && mod.__esModule ? mod : {\n    \"default\": mod\n  };\n};\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.FirefoxLauncher = void 0;\nconst fs_1 = __importDefault(require(\"fs\"));\nconst promises_1 = require(\"fs/promises\");\nconst os_1 = __importDefault(require(\"os\"));\nconst path_1 = __importDefault(require(\"path\"));\nconst browsers_1 = require(\"@puppeteer/browsers\");\nconst util_js_1 = require(\"../common/util.js\");\nconst assert_js_1 = require(\"../util/assert.js\");\nconst ProductLauncher_js_1 = require(\"./ProductLauncher.js\");\nconst fs_js_1 = require(\"./util/fs.js\");\n/**\n * @internal\n */\nclass FirefoxLauncher extends ProductLauncher_js_1.ProductLauncher {\n  constructor(puppeteer) {\n    super(puppeteer, 'firefox');\n  }\n  static getPreferences(extraPrefsFirefox, protocol) {\n    return {\n      ...extraPrefsFirefox,\n      ...(protocol === 'webDriverBiDi' ? {\n        // Only enable the WebDriver BiDi protocol\n        'remote.active-protocols': 1\n      } : {\n        // Do not close the window when the last tab gets closed\n        'browser.tabs.closeWindowWithLastTab': false,\n        // Prevent various error message on the console\n        // jest-puppeteer asserts that no error message is emitted by the console\n        'network.cookie.cookieBehavior': 0,\n        // Temporarily force disable BFCache in parent (https://bit.ly/bug-1732263)\n        'fission.bfcacheInParent': false,\n        // Only enable the CDP protocol\n        'remote.active-protocols': 2\n      }),\n      // Force all web content to use a single content process. TODO: remove\n      // this once Firefox supports mouse event dispatch from the main frame\n      // context. Once this happens, webContentIsolationStrategy should only\n      // be set for CDP. See\n      // https://bugzilla.mozilla.org/show_bug.cgi?id=1773393\n      'fission.webContentIsolationStrategy': 0\n    };\n  }\n  /**\n   * @internal\n   */\n  async computeLaunchArguments(options = {}) {\n    const {\n      ignoreDefaultArgs = false,\n      args = [],\n      executablePath,\n      pipe = false,\n      extraPrefsFirefox = {},\n      debuggingPort = null\n    } = options;\n    const firefoxArguments = [];\n    if (!ignoreDefaultArgs) {\n      firefoxArguments.push(...this.defaultArgs(options));\n    } else if (Array.isArray(ignoreDefaultArgs)) {\n      firefoxArguments.push(...this.defaultArgs(options).filter(arg => {\n        return !ignoreDefaultArgs.includes(arg);\n      }));\n    } else {\n      firefoxArguments.push(...args);\n    }\n    if (!firefoxArguments.some(argument => {\n      return argument.startsWith('--remote-debugging-');\n    })) {\n      if (pipe) {\n        (0, assert_js_1.assert)(debuggingPort === null, 'Browser should be launched with either pipe or debugging port - not both.');\n      }\n      firefoxArguments.push(`--remote-debugging-port=${debuggingPort || 0}`);\n    }\n    let userDataDir;\n    let isTempUserDataDir = true;\n    // Check for the profile argument, which will always be set even\n    // with a custom directory specified via the userDataDir option.\n    const profileArgIndex = firefoxArguments.findIndex(arg => {\n      return ['-profile', '--profile'].includes(arg);\n    });\n    if (profileArgIndex !== -1) {\n      userDataDir = firefoxArguments[profileArgIndex + 1];\n      if (!userDataDir || !fs_1.default.existsSync(userDataDir)) {\n        throw new Error(`Firefox profile not found at '${userDataDir}'`);\n      }\n      // When using a custom Firefox profile it needs to be populated\n      // with required preferences.\n      isTempUserDataDir = false;\n    } else {\n      userDataDir = await (0, promises_1.mkdtemp)(this.getProfilePath());\n      firefoxArguments.push('--profile');\n      firefoxArguments.push(userDataDir);\n    }\n    await (0, browsers_1.createProfile)(browsers_1.Browser.FIREFOX, {\n      path: userDataDir,\n      preferences: FirefoxLauncher.getPreferences(extraPrefsFirefox, options.protocol)\n    });\n    let firefoxExecutable;\n    if (this.puppeteer._isPuppeteerCore || executablePath) {\n      (0, assert_js_1.assert)(executablePath, `An \\`executablePath\\` must be specified for \\`puppeteer-core\\``);\n      firefoxExecutable = executablePath;\n    } else {\n      firefoxExecutable = this.executablePath();\n    }\n    return {\n      isTempUserDataDir,\n      userDataDir,\n      args: firefoxArguments,\n      executablePath: firefoxExecutable\n    };\n  }\n  /**\n   * @internal\n   */\n  async cleanUserDataDir(userDataDir, opts) {\n    if (opts.isTemp) {\n      try {\n        await (0, fs_js_1.rm)(userDataDir);\n      } catch (error) {\n        (0, util_js_1.debugError)(error);\n        throw error;\n      }\n    } else {\n      try {\n        // When an existing user profile has been used remove the user\n        // preferences file and restore possibly backuped preferences.\n        await (0, promises_1.unlink)(path_1.default.join(userDataDir, 'user.js'));\n        const prefsBackupPath = path_1.default.join(userDataDir, 'prefs.js.puppeteer');\n        if (fs_1.default.existsSync(prefsBackupPath)) {\n          const prefsPath = path_1.default.join(userDataDir, 'prefs.js');\n          await (0, promises_1.unlink)(prefsPath);\n          await (0, promises_1.rename)(prefsBackupPath, prefsPath);\n        }\n      } catch (error) {\n        (0, util_js_1.debugError)(error);\n      }\n    }\n  }\n  executablePath() {\n    // replace 'latest' placeholder with actual downloaded revision\n    if (this.puppeteer.browserRevision === 'latest') {\n      const cache = new browsers_1.Cache(this.puppeteer.defaultDownloadPath);\n      const installedFirefox = cache.getInstalledBrowsers().find(browser => {\n        return browser.platform === (0, browsers_1.detectBrowserPlatform)() && browser.browser === browsers_1.Browser.FIREFOX;\n      });\n      if (installedFirefox) {\n        this.actualBrowserRevision = installedFirefox.buildId;\n      }\n    }\n    return this.resolveExecutablePath();\n  }\n  defaultArgs(options = {}) {\n    const {\n      devtools = false,\n      headless = !devtools,\n      args = [],\n      userDataDir = null\n    } = options;\n    const firefoxArguments = ['--no-remote'];\n    switch (os_1.default.platform()) {\n      case 'darwin':\n        firefoxArguments.push('--foreground');\n        break;\n      case 'win32':\n        firefoxArguments.push('--wait-for-browser');\n        break;\n    }\n    if (userDataDir) {\n      firefoxArguments.push('--profile');\n      firefoxArguments.push(userDataDir);\n    }\n    if (headless) {\n      firefoxArguments.push('--headless');\n    }\n    if (devtools) {\n      firefoxArguments.push('--devtools');\n    }\n    if (args.every(arg => {\n      return arg.startsWith('-');\n    })) {\n      firefoxArguments.push('about:blank');\n    }\n    firefoxArguments.push(...args);\n    return firefoxArguments;\n  }\n}\nexports.FirefoxLauncher = FirefoxLauncher;","map":{"version":3,"names":["require","fs_1","__importDefault","promises_1","os_1","path_1","browsers_1","util_js_1","assert_js_1","ProductLauncher_js_1","fs_js_1","FirefoxLauncher","ProductLauncher","constructor","puppeteer","getPreferences","extraPrefsFirefox","protocol","computeLaunchArguments","options","ignoreDefaultArgs","args","executablePath","pipe","debuggingPort","firefoxArguments","push","defaultArgs","Array","isArray","filter","arg","includes","some","argument","startsWith","assert","userDataDir","isTempUserDataDir","profileArgIndex","findIndex","default","existsSync","Error","mkdtemp","getProfilePath","createProfile","Browser","FIREFOX","path","preferences","firefoxExecutable","_isPuppeteerCore","cleanUserDataDir","opts","isTemp","rm","error","debugError","unlink","join","prefsBackupPath","prefsPath","rename","browserRevision","cache","Cache","defaultDownloadPath","installedFirefox","getInstalledBrowsers","find","browser","platform","detectBrowserPlatform","actualBrowserRevision","buildId","resolveExecutablePath","devtools","headless","every","exports"],"sources":["../../../../src/node/FirefoxLauncher.ts"],"sourcesContent":[null],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"script","externalDependencies":[]}