{"ast":null,"code":"\"use strict\";\n\nrequire(\"core-js/modules/es.regexp.flags.js\");\nvar __importDefault = this && this.__importDefault || function (mod) {\n  return mod && mod.__esModule ? mod : {\n    \"default\": mod\n  };\n};\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.file = void 0;\nconst debug_1 = __importDefault(require(\"debug\"));\nconst fs_1 = require(\"fs\");\nconst fs_extra_1 = require(\"fs-extra\");\nconst notfound_1 = __importDefault(require(\"./notfound\"));\nconst notmodified_1 = __importDefault(require(\"./notmodified\"));\nconst url_1 = require(\"url\");\nconst debug = (0, debug_1.default)('get-uri:file');\n/**\n * Returns a `fs.ReadStream` instance from a \"file:\" URI.\n */\nconst file = async ({\n  href: uri\n}, opts = {}) => {\n  const {\n    cache,\n    flags = 'r',\n    mode = 438 // =0666\n  } = opts;\n  try {\n    // Convert URI â†’ Path\n    const filepath = (0, url_1.fileURLToPath)(uri);\n    debug('Normalized pathname: %o', filepath);\n    // `open()` first to get a file descriptor and ensure that the file\n    // exists.\n    const fd = await (0, fs_extra_1.open)(filepath, flags, mode);\n    // Now `fstat()` to check the `mtime` and store the stat object for\n    // the cache.\n    const stat = await (0, fs_extra_1.fstat)(fd);\n    // if a `cache` was provided, check if the file has not been modified\n    if (cache && cache.stat && stat && isNotModified(cache.stat, stat)) {\n      throw new notmodified_1.default();\n    }\n    // `fs.ReadStream` takes care of calling `fs.close()` on the\n    // fd after it's done reading\n    // @ts-expect-error `@types/node` doesn't allow `null` as file path :/\n    const rs = (0, fs_1.createReadStream)(null, {\n      autoClose: true,\n      ...opts,\n      fd\n    });\n    rs.stat = stat;\n    return rs;\n  } catch (err) {\n    if (err.code === 'ENOENT') {\n      throw new notfound_1.default();\n    }\n    throw err;\n  }\n};\nexports.file = file;\n// returns `true` if the `mtime` of the 2 stat objects are equal\nfunction isNotModified(prev, curr) {\n  return +prev.mtime === +curr.mtime;\n}","map":{"version":3,"names":["debug_1","__importDefault","require","fs_1","fs_extra_1","notfound_1","notmodified_1","url_1","debug","default","file","href","uri","opts","cache","flags","mode","filepath","fileURLToPath","fd","open","stat","fstat","isNotModified","rs","createReadStream","autoClose","err","code","exports","prev","curr","mtime"],"sources":["../src/file.ts"],"sourcesContent":[null],"mappings":";;;;;;;;;;;;AACA,MAAAA,OAAA,GAAAC,eAAA,CAAAC,OAAA;AACA,MAAAC,IAAA,GAAAD,OAAA;AACA,MAAAE,UAAA,GAAAF,OAAA;AAEA,MAAAG,UAAA,GAAAJ,eAAA,CAAAC,OAAA;AACA,MAAAI,aAAA,GAAAL,eAAA,CAAAC,OAAA;AACA,MAAAK,KAAA,GAAAL,OAAA;AAEA,MAAMM,KAAK,GAAG,IAAAR,OAAA,CAAAS,OAAW,EAAC,cAAc,CAAC;AAczC;;;AAIO,MAAMC,IAAI,GAAgC,MAAAA,CAChD;EAAEC,IAAI,EAAEC;AAAG,CAAE,EACbC,IAAI,GAAG,EAAE,KACN;EACH,MAAM;IACLC,KAAK;IACLC,KAAK,GAAG,GAAG;IACXC,IAAI,GAAG,GAAG,CAAE;GACZ,GAAGH,IAAI;EAER,IAAI;IACH;IACA,MAAMI,QAAQ,GAAG,IAAAV,KAAA,CAAAW,aAAa,EAACN,GAAG,CAAC;IACnCJ,KAAK,CAAC,yBAAyB,EAAES,QAAQ,CAAC;IAE1C;IACA;IACA,MAAME,EAAE,GAAG,MAAM,IAAAf,UAAA,CAAAgB,IAAI,EAACH,QAAQ,EAAEF,KAAK,EAAEC,IAAI,CAAC;IAE5C;IACA;IACA,MAAMK,IAAI,GAAG,MAAM,IAAAjB,UAAA,CAAAkB,KAAK,EAACH,EAAE,CAAC;IAE5B;IACA,IAAIL,KAAK,IAAIA,KAAK,CAACO,IAAI,IAAIA,IAAI,IAAIE,aAAa,CAACT,KAAK,CAACO,IAAI,EAAEA,IAAI,CAAC,EAAE;MACnE,MAAM,IAAIf,aAAA,CAAAG,OAAgB,EAAE;;IAG7B;IACA;IACA;IACA,MAAMe,EAAE,GAAG,IAAArB,IAAA,CAAAsB,gBAAgB,EAAC,IAAI,EAAE;MACjCC,SAAS,EAAE,IAAI;MACf,GAAGb,IAAI;MACPM;KACA,CAAiB;IAClBK,EAAE,CAACH,IAAI,GAAGA,IAAI;IACd,OAAOG,EAAE;GACT,CAAC,OAAOG,GAAY,EAAE;IACtB,IAAKA,GAA6B,CAACC,IAAI,KAAK,QAAQ,EAAE;MACrD,MAAM,IAAIvB,UAAA,CAAAI,OAAa,EAAE;;IAE1B,MAAMkB,GAAG;;AAEX,CAAC;AA5CYE,OAAA,CAAAnB,IAAI,GAAAA,IAAA;AA8CjB;AACA,SAASa,aAAaA,CAACO,IAAW,EAAEC,IAAW;EAC9C,OAAO,CAACD,IAAI,CAACE,KAAK,KAAK,CAACD,IAAI,CAACC,KAAK;AACnC","ignoreList":[]},"metadata":{},"sourceType":"script","externalDependencies":[]}