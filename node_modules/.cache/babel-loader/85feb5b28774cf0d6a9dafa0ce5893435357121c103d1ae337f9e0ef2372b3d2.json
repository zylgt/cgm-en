{"ast":null,"code":"\"use strict\";\n\n/**\n * @license\n * Copyright 2023 Google Inc.\n * SPDX-License-Identifier: Apache-2.0\n */\nvar __createBinding = this && this.__createBinding || (Object.create ? function (o, m, k, k2) {\n  if (k2 === undefined) k2 = k;\n  var desc = Object.getOwnPropertyDescriptor(m, k);\n  if (!desc || (\"get\" in desc ? !m.__esModule : desc.writable || desc.configurable)) {\n    desc = {\n      enumerable: true,\n      get: function () {\n        return m[k];\n      }\n    };\n  }\n  Object.defineProperty(o, k2, desc);\n} : function (o, m, k, k2) {\n  if (k2 === undefined) k2 = k;\n  o[k2] = m[k];\n});\nvar __setModuleDefault = this && this.__setModuleDefault || (Object.create ? function (o, v) {\n  Object.defineProperty(o, \"default\", {\n    enumerable: true,\n    value: v\n  });\n} : function (o, v) {\n  o[\"default\"] = v;\n});\nvar __importStar = this && this.__importStar || function (mod) {\n  if (mod && mod.__esModule) return mod;\n  var result = {};\n  if (mod != null) for (var k in mod) if (k !== \"default\" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);\n  __setModuleDefault(result, mod);\n  return result;\n};\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.getText = exports.getJSON = exports.downloadFile = exports.httpRequest = exports.headHttpRequest = void 0;\nconst fs_1 = require(\"fs\");\nconst http = __importStar(require(\"http\"));\nconst https = __importStar(require(\"https\"));\nconst url_1 = require(\"url\");\nconst proxy_agent_1 = require(\"proxy-agent\");\nfunction headHttpRequest(url) {\n  return new Promise(resolve => {\n    const request = httpRequest(url, 'HEAD', response => {\n      // consume response data free node process\n      response.resume();\n      resolve(response.statusCode === 200);\n    }, false);\n    request.on('error', () => {\n      resolve(false);\n    });\n  });\n}\nexports.headHttpRequest = headHttpRequest;\nfunction httpRequest(url, method, response, keepAlive = true) {\n  const options = {\n    protocol: url.protocol,\n    hostname: url.hostname,\n    port: url.port,\n    path: url.pathname + url.search,\n    method,\n    headers: keepAlive ? {\n      Connection: 'keep-alive'\n    } : undefined,\n    auth: (0, url_1.urlToHttpOptions)(url).auth,\n    agent: new proxy_agent_1.ProxyAgent()\n  };\n  const requestCallback = res => {\n    if (res.statusCode && res.statusCode >= 300 && res.statusCode < 400 && res.headers.location) {\n      httpRequest(new url_1.URL(res.headers.location), method, response);\n      // consume response data to free up memory\n      // And prevents the connection from being kept alive\n      res.resume();\n    } else {\n      response(res);\n    }\n  };\n  const request = options.protocol === 'https:' ? https.request(options, requestCallback) : http.request(options, requestCallback);\n  request.end();\n  return request;\n}\nexports.httpRequest = httpRequest;\n/**\n * @internal\n */\nfunction downloadFile(url, destinationPath, progressCallback) {\n  return new Promise((resolve, reject) => {\n    let downloadedBytes = 0;\n    let totalBytes = 0;\n    function onData(chunk) {\n      downloadedBytes += chunk.length;\n      progressCallback(downloadedBytes, totalBytes);\n    }\n    const request = httpRequest(url, 'GET', response => {\n      if (response.statusCode !== 200) {\n        const error = new Error(`Download failed: server returned code ${response.statusCode}. URL: ${url}`);\n        // consume response data to free up memory\n        response.resume();\n        reject(error);\n        return;\n      }\n      const file = (0, fs_1.createWriteStream)(destinationPath);\n      file.on('finish', () => {\n        return resolve();\n      });\n      file.on('error', error => {\n        return reject(error);\n      });\n      response.pipe(file);\n      totalBytes = parseInt(response.headers['content-length'], 10);\n      if (progressCallback) {\n        response.on('data', onData);\n      }\n    });\n    request.on('error', error => {\n      return reject(error);\n    });\n  });\n}\nexports.downloadFile = downloadFile;\nasync function getJSON(url) {\n  const text = await getText(url);\n  try {\n    return JSON.parse(text);\n  } catch {\n    throw new Error('Could not parse JSON from ' + url.toString());\n  }\n}\nexports.getJSON = getJSON;\nfunction getText(url) {\n  return new Promise((resolve, reject) => {\n    const request = httpRequest(url, 'GET', response => {\n      let data = '';\n      if (response.statusCode && response.statusCode >= 400) {\n        return reject(new Error(`Got status code ${response.statusCode}`));\n      }\n      response.on('data', chunk => {\n        data += chunk;\n      });\n      response.on('end', () => {\n        try {\n          return resolve(String(data));\n        } catch {\n          return reject(new Error('Chrome version not found'));\n        }\n      });\n    }, false);\n    request.on('error', err => {\n      reject(err);\n    });\n  });\n}\nexports.getText = getText;","map":{"version":3,"names":["fs_1","require","http","__importStar","https","url_1","proxy_agent_1","headHttpRequest","url","Promise","resolve","request","httpRequest","response","resume","statusCode","on","exports","method","keepAlive","options","protocol","hostname","port","path","pathname","search","headers","Connection","undefined","auth","urlToHttpOptions","agent","ProxyAgent","requestCallback","res","location","URL","end","downloadFile","destinationPath","progressCallback","reject","downloadedBytes","totalBytes","onData","chunk","length","error","Error","file","createWriteStream","pipe","parseInt","getJSON","text","getText","JSON","parse","toString","data","String","err"],"sources":["../../src/httpUtil.ts"],"sourcesContent":[null],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"script","externalDependencies":[]}