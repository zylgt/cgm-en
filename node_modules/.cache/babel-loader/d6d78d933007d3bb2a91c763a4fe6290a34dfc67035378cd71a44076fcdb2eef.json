{"ast":null,"code":"\"use strict\";\n\n/**\n * @license\n * Copyright 2019 Google Inc.\n * SPDX-License-Identifier: Apache-2.0\n */\nvar _classPrivateMethodInitSpec = require(\"/Users/hexuemin/Desktop/jiuan/CGM/CGMWeb/node_modules/@babel/runtime/helpers/classPrivateMethodInitSpec.js\").default;\nvar _classPrivateFieldInitSpec = require(\"/Users/hexuemin/Desktop/jiuan/CGM/CGMWeb/node_modules/@babel/runtime/helpers/classPrivateFieldInitSpec.js\").default;\nvar _assertClassBrand = require(\"/Users/hexuemin/Desktop/jiuan/CGM/CGMWeb/node_modules/@babel/runtime/helpers/assertClassBrand.js\").default;\nvar _classPrivateFieldGet = require(\"/Users/hexuemin/Desktop/jiuan/CGM/CGMWeb/node_modules/@babel/runtime/helpers/classPrivateFieldGet2.js\").default;\nvar _classPrivateFieldSet = require(\"/Users/hexuemin/Desktop/jiuan/CGM/CGMWeb/node_modules/@babel/runtime/helpers/classPrivateFieldSet2.js\").default;\nlet _disposable_js_1$disp;\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.IsolatedWorld = void 0;\nconst rxjs_js_1 = require(\"../../third_party/rxjs/rxjs.js\");\nconst Realm_js_1 = require(\"../api/Realm.js\");\nconst EventEmitter_js_1 = require(\"../common/EventEmitter.js\");\nconst util_js_1 = require(\"../common/util.js\");\nconst disposable_js_1 = require(\"../util/disposable.js\");\nconst ElementHandle_js_1 = require(\"./ElementHandle.js\");\nconst JSHandle_js_1 = require(\"./JSHandle.js\");\n/**\n * @internal\n */\nvar _context = /*#__PURE__*/new WeakMap();\nvar _emitter = /*#__PURE__*/new WeakMap();\nvar _frameOrWorker = /*#__PURE__*/new WeakMap();\nvar _IsolatedWorld_brand = /*#__PURE__*/new WeakSet();\n_disposable_js_1$disp = disposable_js_1.disposeSymbol;\nclass IsolatedWorld extends Realm_js_1.Realm {\n  constructor(frameOrWorker, timeoutSettings) {\n    super(timeoutSettings);\n    _classPrivateMethodInitSpec(this, _IsolatedWorld_brand);\n    _classPrivateFieldInitSpec(this, _context, void 0);\n    _classPrivateFieldInitSpec(this, _emitter, new EventEmitter_js_1.EventEmitter());\n    _classPrivateFieldInitSpec(this, _frameOrWorker, void 0);\n    _classPrivateFieldSet(_frameOrWorker, this, frameOrWorker);\n  }\n  get environment() {\n    return _classPrivateFieldGet(_frameOrWorker, this);\n  }\n  get client() {\n    return _classPrivateFieldGet(_frameOrWorker, this).client;\n  }\n  get emitter() {\n    return _classPrivateFieldGet(_emitter, this);\n  }\n  setContext(context) {\n    _classPrivateFieldGet(_context, this)?.[disposable_js_1.disposeSymbol]();\n    context.once('disposed', _assertClassBrand(_IsolatedWorld_brand, this, _onContextDisposed).bind(this));\n    context.on('consoleapicalled', _assertClassBrand(_IsolatedWorld_brand, this, _onContextConsoleApiCalled).bind(this));\n    context.on('bindingcalled', _assertClassBrand(_IsolatedWorld_brand, this, _onContextBindingCalled).bind(this));\n    _classPrivateFieldSet(_context, this, context);\n    _classPrivateFieldGet(_emitter, this).emit('context', context);\n    void this.taskManager.rerunAll();\n  }\n  hasContext() {\n    return !!_classPrivateFieldGet(_context, this);\n  }\n  get context() {\n    return _classPrivateFieldGet(_context, this);\n  }\n  async evaluateHandle(pageFunction, ...args) {\n    pageFunction = (0, util_js_1.withSourcePuppeteerURLIfNone)(this.evaluateHandle.name, pageFunction);\n    // This code needs to schedule evaluateHandle call synchroniously (at\n    // least when the context is there) so we cannot unconditionally\n    // await.\n    let context = _assertClassBrand(_IsolatedWorld_brand, this, _executionContext).call(this);\n    if (!context) {\n      context = await _assertClassBrand(_IsolatedWorld_brand, this, _waitForExecutionContext).call(this);\n    }\n    return await context.evaluateHandle(pageFunction, ...args);\n  }\n  async evaluate(pageFunction, ...args) {\n    pageFunction = (0, util_js_1.withSourcePuppeteerURLIfNone)(this.evaluate.name, pageFunction);\n    // This code needs to schedule evaluate call synchroniously (at\n    // least when the context is there) so we cannot unconditionally\n    // await.\n    let context = _assertClassBrand(_IsolatedWorld_brand, this, _executionContext).call(this);\n    if (!context) {\n      context = await _assertClassBrand(_IsolatedWorld_brand, this, _waitForExecutionContext).call(this);\n    }\n    return await context.evaluate(pageFunction, ...args);\n  }\n  async adoptBackendNode(backendNodeId) {\n    // This code needs to schedule resolveNode call synchroniously (at\n    // least when the context is there) so we cannot unconditionally\n    // await.\n    let context = _assertClassBrand(_IsolatedWorld_brand, this, _executionContext).call(this);\n    if (!context) {\n      context = await _assertClassBrand(_IsolatedWorld_brand, this, _waitForExecutionContext).call(this);\n    }\n    const {\n      object\n    } = await this.client.send('DOM.resolveNode', {\n      backendNodeId: backendNodeId,\n      executionContextId: context.id\n    });\n    return this.createCdpHandle(object);\n  }\n  async adoptHandle(handle) {\n    if (handle.realm === this) {\n      // If the context has already adopted this handle, clone it so downstream\n      // disposal doesn't become an issue.\n      return await handle.evaluateHandle(value => {\n        return value;\n      });\n    }\n    const nodeInfo = await this.client.send('DOM.describeNode', {\n      objectId: handle.id\n    });\n    return await this.adoptBackendNode(nodeInfo.node.backendNodeId);\n  }\n  async transferHandle(handle) {\n    if (handle.realm === this) {\n      return handle;\n    }\n    // Implies it's a primitive value, probably.\n    if (handle.remoteObject().objectId === undefined) {\n      return handle;\n    }\n    const info = await this.client.send('DOM.describeNode', {\n      objectId: handle.remoteObject().objectId\n    });\n    const newHandle = await this.adoptBackendNode(info.node.backendNodeId);\n    await handle.dispose();\n    return newHandle;\n  }\n  /**\n   * @internal\n   */\n  createCdpHandle(remoteObject) {\n    if (remoteObject.subtype === 'node') {\n      return new ElementHandle_js_1.CdpElementHandle(this, remoteObject);\n    }\n    return new JSHandle_js_1.CdpJSHandle(this, remoteObject);\n  }\n  [_disposable_js_1$disp]() {\n    _classPrivateFieldGet(_context, this)?.[disposable_js_1.disposeSymbol]();\n    _classPrivateFieldGet(_emitter, this).emit('disposed', undefined);\n    super[disposable_js_1.disposeSymbol]();\n    _classPrivateFieldGet(_emitter, this).removeAllListeners();\n  }\n}\nfunction _onContextDisposed() {\n  _classPrivateFieldSet(_context, this, undefined);\n  if ('clearDocumentHandle' in _classPrivateFieldGet(_frameOrWorker, this)) {\n    _classPrivateFieldGet(_frameOrWorker, this).clearDocumentHandle();\n  }\n}\nfunction _onContextConsoleApiCalled(event) {\n  _classPrivateFieldGet(_emitter, this).emit('consoleapicalled', event);\n}\nfunction _onContextBindingCalled(event) {\n  _classPrivateFieldGet(_emitter, this).emit('bindingcalled', event);\n}\nfunction _executionContext() {\n  if (this.disposed) {\n    throw new Error(`Execution context is not available in detached frame or worker \"${this.environment.url()}\" (are you trying to evaluate?)`);\n  }\n  return _classPrivateFieldGet(_context, this);\n}\n/**\n * Waits for the next context to be set on the isolated world.\n */\nasync function _waitForExecutionContext() {\n  const result = await (0, rxjs_js_1.firstValueFrom)((0, util_js_1.fromEmitterEvent)(_classPrivateFieldGet(_emitter, this), 'context').pipe((0, rxjs_js_1.raceWith)((0, util_js_1.fromEmitterEvent)(_classPrivateFieldGet(_emitter, this), 'disposed').pipe((0, rxjs_js_1.map)(() => {\n    // The message has to match the CDP message expected by the WaitTask class.\n    throw new Error('Execution context was destroyed');\n  })))));\n  return result;\n}\nexports.IsolatedWorld = IsolatedWorld;","map":{"version":3,"names":["_classPrivateMethodInitSpec","require","default","_classPrivateFieldInitSpec","_assertClassBrand","_classPrivateFieldGet","_classPrivateFieldSet","_disposable_js_1$disp","rxjs_js_1","Realm_js_1","EventEmitter_js_1","util_js_1","disposable_js_1","ElementHandle_js_1","JSHandle_js_1","_context","WeakMap","_emitter","_frameOrWorker","_IsolatedWorld_brand","WeakSet","disposeSymbol","IsolatedWorld","Realm","constructor","frameOrWorker","timeoutSettings","EventEmitter","environment","client","emitter","setContext","context","once","_onContextDisposed","bind","on","_onContextConsoleApiCalled","_onContextBindingCalled","emit","taskManager","rerunAll","hasContext","evaluateHandle","pageFunction","args","withSourcePuppeteerURLIfNone","name","_executionContext","call","_waitForExecutionContext","evaluate","adoptBackendNode","backendNodeId","object","send","executionContextId","id","createCdpHandle","adoptHandle","handle","realm","value","nodeInfo","objectId","node","transferHandle","remoteObject","undefined","info","newHandle","dispose","subtype","CdpElementHandle","CdpJSHandle","removeAllListeners","clearDocumentHandle","event","disposed","Error","url","result","firstValueFrom","fromEmitterEvent","pipe","raceWith","map","exports"],"sources":["../../../../src/cdp/IsolatedWorld.ts"],"sourcesContent":[null],"mappings":";;AAAA;;;;;AAAA,IAAAA,2BAAA,GAAAC,OAAA,+GAAAC,OAAA;AAAA,IAAAC,0BAAA,GAAAF,OAAA,8GAAAC,OAAA;AAAA,IAAAE,iBAAA,GAAAH,OAAA,qGAAAC,OAAA;AAAA,IAAAG,qBAAA,GAAAJ,OAAA,0GAAAC,OAAA;AAAA,IAAAI,qBAAA,GAAAL,OAAA,0GAAAC,OAAA;AAAA,IAAAK,qBAAA;;;;;AAQA,MAAAC,SAAA,GAAAP,OAAA;AAIA,MAAAQ,UAAA,GAAAR,OAAA;AACA,MAAAS,iBAAA,GAAAT,OAAA;AAGA,MAAAU,SAAA,GAAAV,OAAA;AAIA,MAAAW,eAAA,GAAAX,OAAA;AAEA,MAAAY,kBAAA,GAAAZ,OAAA;AAIA,MAAAa,aAAA,GAAAb,OAAA;AAkCA;;;AAAA,IAAAc,QAAA,oBAAAC,OAAA;AAAA,IAAAC,QAAA,oBAAAD,OAAA;AAAA,IAAAE,cAAA,oBAAAF,OAAA;AAAA,IAAAG,oBAAA,oBAAAC,OAAA;AAAAb,qBAAA,GAmMGK,eAAA,CAAAS,aAAa;AAhMhB,MAAaC,aAAc,SAAQb,UAAA,CAAAc,KAAK;EAMtCC,YACEC,aAAsC,EACtCC,eAAgC;IAEhC,KAAK,CAACA,eAAe,CAAC;IAAC1B,2BAAA,OAAAmB,oBAAA;IAAAhB,0BAAA,OAAAY,QAAA;IAAAZ,0BAAA,OAAAc,QAAA,EARQ,IAAIP,iBAAA,CAAAiB,YAAY,EAAE;IAAAxB,0BAAA,OAAAe,cAAA;IASjDZ,qBAAA,CAAAY,cAAA,MAAI,EAAkBO,aAAa;EACrC;EAEA,IAAIG,WAAWA,CAAA;IACb,OAAAvB,qBAAA,CAAAa,cAAA,EAAO,IAAI;EACb;EAEA,IAAIW,MAAMA,CAAA;IACR,OAAOxB,qBAAA,CAAAa,cAAA,MAAI,EAAgBW,MAAM;EACnC;EAEA,IAAIC,OAAOA,CAAA;IACT,OAAAzB,qBAAA,CAAAY,QAAA,EAAO,IAAI;EACb;EAEAc,UAAUA,CAACC,OAAyB;IAClC3B,qBAAA,CAAAU,QAAA,MAAI,IAAYH,eAAA,CAAAS,aAAa,CAAC,EAAE;IAChCW,OAAO,CAACC,IAAI,CAAC,UAAU,EAAE7B,iBAAA,CAAAe,oBAAA,MAAI,EAAAe,kBAAA,EAAoBC,IAAI,CAAC,IAAI,CAAC,CAAC;IAC5DH,OAAO,CAACI,EAAE,CAAC,kBAAkB,EAAEhC,iBAAA,CAAAe,oBAAA,MAAI,EAAAkB,0BAAA,EAA4BF,IAAI,CAAC,IAAI,CAAC,CAAC;IAC1EH,OAAO,CAACI,EAAE,CAAC,eAAe,EAAEhC,iBAAA,CAAAe,oBAAA,MAAI,EAAAmB,uBAAA,EAAyBH,IAAI,CAAC,IAAI,CAAC,CAAC;IACpE7B,qBAAA,CAAAS,QAAA,MAAI,EAAYiB,OAAO;IACvB3B,qBAAA,CAAAY,QAAA,MAAI,EAAUsB,IAAI,CAAC,SAAS,EAAEP,OAAO,CAAC;IACtC,KAAK,IAAI,CAACQ,WAAW,CAACC,QAAQ,EAAE;EAClC;EAmBAC,UAAUA,CAAA;IACR,OAAO,CAAC,CAAArC,qBAAA,CAAAU,QAAA,EAAC,IAAI,CAAS;EACxB;EAEA,IAAIiB,OAAOA,CAAA;IACT,OAAA3B,qBAAA,CAAAU,QAAA,EAAO,IAAI;EACb;EA8BA,MAAM4B,cAAcA,CAIlBC,YAA2B,EAC3B,GAAGC,IAAY;IAEfD,YAAY,GAAG,IAAAjC,SAAA,CAAAmC,4BAA4B,EACzC,IAAI,CAACH,cAAc,CAACI,IAAI,EACxBH,YAAY,CACb;IACD;IACA;IACA;IACA,IAAIZ,OAAO,GAAA5B,iBAAA,CAAAe,oBAAA,EAAG,IAAI,EAAA6B,iBAAA,EAAAC,IAAA,CAAJ,IAAI,CAAoB;IACtC,IAAI,CAACjB,OAAO,EAAE;MACZA,OAAO,GAAG,MAAA5B,iBAAA,CAAAe,oBAAA,EAAM,IAAI,EAAA+B,wBAAA,EAAAD,IAAA,CAAJ,IAAI,CAA2B;IACjD;IACA,OAAO,MAAMjB,OAAO,CAACW,cAAc,CAACC,YAAY,EAAE,GAAGC,IAAI,CAAC;EAC5D;EAEA,MAAMM,QAAQA,CAIZP,YAA2B,EAC3B,GAAGC,IAAY;IAEfD,YAAY,GAAG,IAAAjC,SAAA,CAAAmC,4BAA4B,EACzC,IAAI,CAACK,QAAQ,CAACJ,IAAI,EAClBH,YAAY,CACb;IACD;IACA;IACA;IACA,IAAIZ,OAAO,GAAA5B,iBAAA,CAAAe,oBAAA,EAAG,IAAI,EAAA6B,iBAAA,EAAAC,IAAA,CAAJ,IAAI,CAAoB;IACtC,IAAI,CAACjB,OAAO,EAAE;MACZA,OAAO,GAAG,MAAA5B,iBAAA,CAAAe,oBAAA,EAAM,IAAI,EAAA+B,wBAAA,EAAAD,IAAA,CAAJ,IAAI,CAA2B;IACjD;IACA,OAAO,MAAMjB,OAAO,CAACmB,QAAQ,CAACP,YAAY,EAAE,GAAGC,IAAI,CAAC;EACtD;EAES,MAAMO,gBAAgBA,CAC7BC,aAA0C;IAE1C;IACA;IACA;IACA,IAAIrB,OAAO,GAAA5B,iBAAA,CAAAe,oBAAA,EAAG,IAAI,EAAA6B,iBAAA,EAAAC,IAAA,CAAJ,IAAI,CAAoB;IACtC,IAAI,CAACjB,OAAO,EAAE;MACZA,OAAO,GAAG,MAAA5B,iBAAA,CAAAe,oBAAA,EAAM,IAAI,EAAA+B,wBAAA,EAAAD,IAAA,CAAJ,IAAI,CAA2B;IACjD;IACA,MAAM;MAACK;IAAM,CAAC,GAAG,MAAM,IAAI,CAACzB,MAAM,CAAC0B,IAAI,CAAC,iBAAiB,EAAE;MACzDF,aAAa,EAAEA,aAAa;MAC5BG,kBAAkB,EAAExB,OAAO,CAACyB;KAC7B,CAAC;IACF,OAAO,IAAI,CAACC,eAAe,CAACJ,MAAM,CAAmB;EACvD;EAEA,MAAMK,WAAWA,CAA2BC,MAAS;IACnD,IAAIA,MAAM,CAACC,KAAK,KAAK,IAAI,EAAE;MACzB;MACA;MACA,OAAQ,MAAMD,MAAM,CAACjB,cAAc,CAACmB,KAAK,IAAG;QAC1C,OAAOA,KAAK;MACd,CAAC,CAAC;IACJ;IACA,MAAMC,QAAQ,GAAG,MAAM,IAAI,CAAClC,MAAM,CAAC0B,IAAI,CAAC,kBAAkB,EAAE;MAC1DS,QAAQ,EAAEJ,MAAM,CAACH;KAClB,CAAC;IACF,OAAQ,MAAM,IAAI,CAACL,gBAAgB,CAACW,QAAQ,CAACE,IAAI,CAACZ,aAAa,CAAC;EAClE;EAEA,MAAMa,cAAcA,CAA2BN,MAAS;IACtD,IAAIA,MAAM,CAACC,KAAK,KAAK,IAAI,EAAE;MACzB,OAAOD,MAAM;IACf;IACA;IACA,IAAIA,MAAM,CAACO,YAAY,EAAE,CAACH,QAAQ,KAAKI,SAAS,EAAE;MAChD,OAAOR,MAAM;IACf;IACA,MAAMS,IAAI,GAAG,MAAM,IAAI,CAACxC,MAAM,CAAC0B,IAAI,CAAC,kBAAkB,EAAE;MACtDS,QAAQ,EAAEJ,MAAM,CAACO,YAAY,EAAE,CAACH;KACjC,CAAC;IACF,MAAMM,SAAS,GAAI,MAAM,IAAI,CAAClB,gBAAgB,CAC5CiB,IAAI,CAACJ,IAAI,CAACZ,aAAa,CAClB;IACP,MAAMO,MAAM,CAACW,OAAO,EAAE;IACtB,OAAOD,SAAS;EAClB;EAEA;;;EAGAZ,eAAeA,CACbS,YAA2C;IAE3C,IAAIA,YAAY,CAACK,OAAO,KAAK,MAAM,EAAE;MACnC,OAAO,IAAI3D,kBAAA,CAAA4D,gBAAgB,CAAC,IAAI,EAAEN,YAAY,CAAC;IACjD;IACA,OAAO,IAAIrD,aAAA,CAAA4D,WAAW,CAAC,IAAI,EAAEP,YAAY,CAAC;EAC5C;EAEA,CAAA5D,qBAAA,IAAe;IACbF,qBAAA,CAAAU,QAAA,MAAI,IAAYH,eAAA,CAAAS,aAAa,CAAC,EAAE;IAChChB,qBAAA,CAAAY,QAAA,MAAI,EAAUsB,IAAI,CAAC,UAAU,EAAE6B,SAAS,CAAC;IACzC,KAAK,CAACxD,eAAA,CAAAS,aAAa,CAAC,EAAE;IACtBhB,qBAAA,CAAAY,QAAA,MAAI,EAAU0D,kBAAkB,EAAE;EACpC;;AACD,SAAAzC,mBAAA,EAlKmB;EAChB5B,qBAAA,CAAAS,QAAA,MAAI,EAAYqD,SAAS;EACzB,IAAI,qBAAqB,IAAA/D,qBAAA,CAAAa,cAAA,EAAI,IAAI,CAAe,EAAE;IAChDb,qBAAA,CAAAa,cAAA,MAAI,EAAgB0D,mBAAmB,EAAE;EAC3C;AACF;AAAC,SAAAvC,2BAGCwC,KAA6C;EAE7CxE,qBAAA,CAAAY,QAAA,MAAI,EAAUsB,IAAI,CAAC,kBAAkB,EAAEsC,KAAK,CAAC;AAC/C;AAAC,SAAAvC,wBAEuBuC,KAA0C;EAChExE,qBAAA,CAAAY,QAAA,MAAI,EAAUsB,IAAI,CAAC,eAAe,EAAEsC,KAAK,CAAC;AAC5C;AAAC,SAAA7B,kBAAA,EAUgB;EACf,IAAI,IAAI,CAAC8B,QAAQ,EAAE;IACjB,MAAM,IAAIC,KAAK,CACb,mEAAmE,IAAI,CAACnD,WAAW,CAACoD,GAAG,EAAE,iCAAiC,CAC3H;EACH;EACA,OAAA3E,qBAAA,CAAAU,QAAA,EAAO,IAAI;AACb;AAEA;;;AAAA,eAAAmC,yBAAA,EAG8B;EAC5B,MAAM+B,MAAM,GAAG,MAAM,IAAAzE,SAAA,CAAA0E,cAAc,EACjC,IAAAvE,SAAA,CAAAwE,gBAAgB,EAAA9E,qBAAA,CAAAY,QAAA,EAAC,IAAI,GAAW,SAAS,CAAC,CAACmE,IAAI,CAC7C,IAAA5E,SAAA,CAAA6E,QAAQ,EACN,IAAA1E,SAAA,CAAAwE,gBAAgB,EAAA9E,qBAAA,CAAAY,QAAA,EAAC,IAAI,GAAW,UAAU,CAAC,CAACmE,IAAI,CAC9C,IAAA5E,SAAA,CAAA8E,GAAG,EAAC,MAAK;IACP;IACA,MAAM,IAAIP,KAAK,CAAC,iCAAiC,CAAC;EACpD,CAAC,CAAC,CACH,CACF,CACF,CACF;EACD,OAAOE,MAAM;AACf;AAvFFM,OAAA,CAAAjE,aAAA,GAAAA,aAAA","ignoreList":[]},"metadata":{},"sourceType":"script","externalDependencies":[]}