{"ast":null,"code":"\"use strict\";\n\n/**\n * @license\n * Copyright 2017 Google Inc.\n * SPDX-License-Identifier: Apache-2.0\n */\nrequire(\"core-js/modules/es.array.push.js\");\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.pageBindingInitString = exports.addPageBinding = exports.valueFromRemoteObject = exports.createClientError = exports.createEvaluationError = void 0;\nconst util_js_1 = require(\"../common/util.js\");\nconst assert_js_1 = require(\"../util/assert.js\");\n/**\n * @internal\n */\nfunction createEvaluationError(details) {\n  let name;\n  let message;\n  if (!details.exception) {\n    name = 'Error';\n    message = details.text;\n  } else if ((details.exception.type !== 'object' || details.exception.subtype !== 'error') && !details.exception.objectId) {\n    return valueFromRemoteObject(details.exception);\n  } else {\n    const detail = getErrorDetails(details);\n    name = detail.name;\n    message = detail.message;\n  }\n  const messageHeight = message.split('\\n').length;\n  const error = new Error(message);\n  error.name = name;\n  const stackLines = error.stack.split('\\n');\n  const messageLines = stackLines.splice(0, messageHeight);\n  // The first line is this function which we ignore.\n  stackLines.shift();\n  if (details.stackTrace && stackLines.length < Error.stackTraceLimit) {\n    for (const frame of details.stackTrace.callFrames.reverse()) {\n      if (util_js_1.PuppeteerURL.isPuppeteerURL(frame.url) && frame.url !== util_js_1.PuppeteerURL.INTERNAL_URL) {\n        const url = util_js_1.PuppeteerURL.parse(frame.url);\n        stackLines.unshift(`    at ${frame.functionName || url.functionName} (${url.functionName} at ${url.siteString}, <anonymous>:${frame.lineNumber}:${frame.columnNumber})`);\n      } else {\n        stackLines.push(`    at ${frame.functionName || '<anonymous>'} (${frame.url}:${frame.lineNumber}:${frame.columnNumber})`);\n      }\n      if (stackLines.length >= Error.stackTraceLimit) {\n        break;\n      }\n    }\n  }\n  error.stack = [...messageLines, ...stackLines].join('\\n');\n  return error;\n}\nexports.createEvaluationError = createEvaluationError;\nconst getErrorDetails = details => {\n  let name = '';\n  let message;\n  const lines = details.exception?.description?.split('\\n    at ') ?? [];\n  const size = Math.min(details.stackTrace?.callFrames.length ?? 0, lines.length - 1);\n  lines.splice(-size, size);\n  if (details.exception?.className) {\n    name = details.exception.className;\n  }\n  message = lines.join('\\n');\n  if (name && message.startsWith(`${name}: `)) {\n    message = message.slice(name.length + 2);\n  }\n  return {\n    message,\n    name\n  };\n};\n/**\n * @internal\n */\nfunction createClientError(details) {\n  let name;\n  let message;\n  if (!details.exception) {\n    name = 'Error';\n    message = details.text;\n  } else if ((details.exception.type !== 'object' || details.exception.subtype !== 'error') && !details.exception.objectId) {\n    return valueFromRemoteObject(details.exception);\n  } else {\n    const detail = getErrorDetails(details);\n    name = detail.name;\n    message = detail.message;\n  }\n  const error = new Error(message);\n  error.name = name;\n  const messageHeight = error.message.split('\\n').length;\n  const messageLines = error.stack.split('\\n').splice(0, messageHeight);\n  const stackLines = [];\n  if (details.stackTrace) {\n    for (const frame of details.stackTrace.callFrames) {\n      // Note we need to add `1` because the values are 0-indexed.\n      stackLines.push(`    at ${frame.functionName || '<anonymous>'} (${frame.url}:${frame.lineNumber + 1}:${frame.columnNumber + 1})`);\n      if (stackLines.length >= Error.stackTraceLimit) {\n        break;\n      }\n    }\n  }\n  error.stack = [...messageLines, ...stackLines].join('\\n');\n  return error;\n}\nexports.createClientError = createClientError;\n/**\n * @internal\n */\nfunction valueFromRemoteObject(remoteObject) {\n  (0, assert_js_1.assert)(!remoteObject.objectId, 'Cannot extract value when objectId is given');\n  if (remoteObject.unserializableValue) {\n    if (remoteObject.type === 'bigint') {\n      return BigInt(remoteObject.unserializableValue.replace('n', ''));\n    }\n    switch (remoteObject.unserializableValue) {\n      case '-0':\n        return -0;\n      case 'NaN':\n        return NaN;\n      case 'Infinity':\n        return Infinity;\n      case '-Infinity':\n        return -Infinity;\n      default:\n        throw new Error('Unsupported unserializable value: ' + remoteObject.unserializableValue);\n    }\n  }\n  return remoteObject.value;\n}\nexports.valueFromRemoteObject = valueFromRemoteObject;\n/**\n * @internal\n */\nfunction addPageBinding(type, name) {\n  // This is the CDP binding.\n  // @ts-expect-error: In a different context.\n  const callCdp = globalThis[name];\n  // Depending on the frame loading state either Runtime.evaluate or\n  // Page.addScriptToEvaluateOnNewDocument might succeed. Let's check that we\n  // don't re-wrap Puppeteer's binding.\n  if (callCdp[Symbol.toStringTag] === 'PuppeteerBinding') {\n    return;\n  }\n  // We replace the CDP binding with a Puppeteer binding.\n  Object.assign(globalThis, {\n    [name](...args) {\n      // This is the Puppeteer binding.\n      // @ts-expect-error: In a different context.\n      const callPuppeteer = globalThis[name];\n      callPuppeteer.args ??= new Map();\n      callPuppeteer.callbacks ??= new Map();\n      const seq = (callPuppeteer.lastSeq ?? 0) + 1;\n      callPuppeteer.lastSeq = seq;\n      callPuppeteer.args.set(seq, args);\n      callCdp(JSON.stringify({\n        type,\n        name,\n        seq,\n        args,\n        isTrivial: !args.some(value => {\n          return value instanceof Node;\n        })\n      }));\n      return new Promise((resolve, reject) => {\n        callPuppeteer.callbacks.set(seq, {\n          resolve(value) {\n            callPuppeteer.args.delete(seq);\n            resolve(value);\n          },\n          reject(value) {\n            callPuppeteer.args.delete(seq);\n            reject(value);\n          }\n        });\n      });\n    }\n  });\n  // @ts-expect-error: In a different context.\n  globalThis[name][Symbol.toStringTag] = 'PuppeteerBinding';\n}\nexports.addPageBinding = addPageBinding;\n/**\n * @internal\n */\nfunction pageBindingInitString(type, name) {\n  return (0, util_js_1.evaluationString)(addPageBinding, type, name);\n}\nexports.pageBindingInitString = pageBindingInitString;","map":{"version":3,"names":["require","util_js_1","assert_js_1","createEvaluationError","details","name","message","exception","text","type","subtype","objectId","valueFromRemoteObject","detail","getErrorDetails","messageHeight","split","length","error","Error","stackLines","stack","messageLines","splice","shift","stackTrace","stackTraceLimit","frame","callFrames","reverse","PuppeteerURL","isPuppeteerURL","url","INTERNAL_URL","parse","unshift","functionName","siteString","lineNumber","columnNumber","push","join","exports","lines","description","size","Math","min","className","startsWith","slice","createClientError","remoteObject","assert","unserializableValue","BigInt","replace","NaN","Infinity","value","addPageBinding","callCdp","globalThis","Symbol","toStringTag","Object","assign","args","callPuppeteer","Map","callbacks","seq","lastSeq","set","JSON","stringify","isTrivial","some","Node","Promise","resolve","reject","delete","pageBindingInitString","evaluationString"],"sources":["../../../../src/cdp/utils.ts"],"sourcesContent":[null],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"script","externalDependencies":[]}