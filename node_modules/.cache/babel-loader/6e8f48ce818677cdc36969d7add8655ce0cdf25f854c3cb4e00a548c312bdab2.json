{"ast":null,"code":"\"use strict\";\n\n/**\n * @license\n * Copyright 2023 Google Inc.\n * SPDX-License-Identifier: Apache-2.0\n */\nvar _classPrivateFieldSet = require(\"/Users/hexuemin/Desktop/jiuan/CGM/CGMWeb/node_modules/@babel/runtime/helpers/classPrivateFieldSet2.js\").default;\nvar _classPrivateFieldInitSpec = require(\"/Users/hexuemin/Desktop/jiuan/CGM/CGMWeb/node_modules/@babel/runtime/helpers/classPrivateFieldInitSpec.js\").default;\nvar _classPrivateFieldGet = require(\"/Users/hexuemin/Desktop/jiuan/CGM/CGMWeb/node_modules/@babel/runtime/helpers/classPrivateFieldGet2.js\").default;\nrequire(\"core-js/modules/es.array.push.js\");\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.createIncrementalIdGenerator = exports.Callback = exports.CallbackRegistry = void 0;\nconst Deferred_js_1 = require(\"../util/Deferred.js\");\nconst ErrorLike_js_1 = require(\"../util/ErrorLike.js\");\nconst Errors_js_1 = require(\"./Errors.js\");\nconst util_js_1 = require(\"./util.js\");\n/**\n * Manages callbacks and their IDs for the protocol request/response communication.\n *\n * @internal\n */\nvar _callbacks = /*#__PURE__*/new WeakMap();\nvar _idGenerator = /*#__PURE__*/new WeakMap();\nclass CallbackRegistry {\n  constructor() {\n    _classPrivateFieldInitSpec(this, _callbacks, new Map());\n    _classPrivateFieldInitSpec(this, _idGenerator, createIncrementalIdGenerator());\n  }\n  create(label, timeout, request) {\n    const callback = new Callback(_classPrivateFieldGet(_idGenerator, this).call(this), label, timeout);\n    _classPrivateFieldGet(_callbacks, this).set(callback.id, callback);\n    try {\n      request(callback.id);\n    } catch (error) {\n      // We still throw sync errors synchronously and clean up the scheduled\n      // callback.\n      callback.promise.catch(util_js_1.debugError).finally(() => {\n        _classPrivateFieldGet(_callbacks, this).delete(callback.id);\n      });\n      callback.reject(error);\n      throw error;\n    }\n    // Must only have sync code up until here.\n    return callback.promise.finally(() => {\n      _classPrivateFieldGet(_callbacks, this).delete(callback.id);\n    });\n  }\n  reject(id, message, originalMessage) {\n    const callback = _classPrivateFieldGet(_callbacks, this).get(id);\n    if (!callback) {\n      return;\n    }\n    this._reject(callback, message, originalMessage);\n  }\n  _reject(callback, errorMessage, originalMessage) {\n    let error;\n    let message;\n    if (errorMessage instanceof Errors_js_1.ProtocolError) {\n      error = errorMessage;\n      error.cause = callback.error;\n      message = errorMessage.message;\n    } else {\n      error = callback.error;\n      message = errorMessage;\n    }\n    callback.reject((0, ErrorLike_js_1.rewriteError)(error, `Protocol error (${callback.label}): ${message}`, originalMessage));\n  }\n  resolve(id, value) {\n    const callback = _classPrivateFieldGet(_callbacks, this).get(id);\n    if (!callback) {\n      return;\n    }\n    callback.resolve(value);\n  }\n  clear() {\n    for (const callback of _classPrivateFieldGet(_callbacks, this).values()) {\n      // TODO: probably we can accept error messages as params.\n      this._reject(callback, new Errors_js_1.TargetCloseError('Target closed'));\n    }\n    _classPrivateFieldGet(_callbacks, this).clear();\n  }\n  /**\n   * @internal\n   */\n  getPendingProtocolErrors() {\n    const result = [];\n    for (const callback of _classPrivateFieldGet(_callbacks, this).values()) {\n      result.push(new Error(`${callback.label} timed out. Trace: ${callback.error.stack}`));\n    }\n    return result;\n  }\n}\nexports.CallbackRegistry = CallbackRegistry;\n/**\n * @internal\n */\nvar _id = /*#__PURE__*/new WeakMap();\nvar _error = /*#__PURE__*/new WeakMap();\nvar _deferred = /*#__PURE__*/new WeakMap();\nvar _timer = /*#__PURE__*/new WeakMap();\nvar _label = /*#__PURE__*/new WeakMap();\nclass Callback {\n  constructor(id, label, timeout) {\n    _classPrivateFieldInitSpec(this, _id, void 0);\n    _classPrivateFieldInitSpec(this, _error, new Errors_js_1.ProtocolError());\n    _classPrivateFieldInitSpec(this, _deferred, Deferred_js_1.Deferred.create());\n    _classPrivateFieldInitSpec(this, _timer, void 0);\n    _classPrivateFieldInitSpec(this, _label, void 0);\n    _classPrivateFieldSet(_id, this, id);\n    _classPrivateFieldSet(_label, this, label);\n    if (timeout) {\n      _classPrivateFieldSet(_timer, this, setTimeout(() => {\n        _classPrivateFieldGet(_deferred, this).reject((0, ErrorLike_js_1.rewriteError)(_classPrivateFieldGet(_error, this), `${label} timed out. Increase the 'protocolTimeout' setting in launch/connect calls for a higher timeout if needed.`));\n      }, timeout));\n    }\n  }\n  resolve(value) {\n    clearTimeout(_classPrivateFieldGet(_timer, this));\n    _classPrivateFieldGet(_deferred, this).resolve(value);\n  }\n  reject(error) {\n    clearTimeout(_classPrivateFieldGet(_timer, this));\n    _classPrivateFieldGet(_deferred, this).reject(error);\n  }\n  get id() {\n    return _classPrivateFieldGet(_id, this);\n  }\n  get promise() {\n    return _classPrivateFieldGet(_deferred, this).valueOrThrow();\n  }\n  get error() {\n    return _classPrivateFieldGet(_error, this);\n  }\n  get label() {\n    return _classPrivateFieldGet(_label, this);\n  }\n}\nexports.Callback = Callback;\n/**\n * @internal\n */\nfunction createIncrementalIdGenerator() {\n  let id = 0;\n  return () => {\n    return ++id;\n  };\n}\nexports.createIncrementalIdGenerator = createIncrementalIdGenerator;","map":{"version":3,"names":["_classPrivateFieldSet","require","default","_classPrivateFieldInitSpec","_classPrivateFieldGet","Deferred_js_1","ErrorLike_js_1","Errors_js_1","util_js_1","_callbacks","WeakMap","_idGenerator","CallbackRegistry","constructor","Map","createIncrementalIdGenerator","create","label","timeout","request","callback","Callback","call","set","id","error","promise","catch","debugError","finally","delete","reject","message","originalMessage","get","_reject","errorMessage","ProtocolError","cause","rewriteError","resolve","value","clear","values","TargetCloseError","getPendingProtocolErrors","result","push","Error","stack","exports","_id","_error","_deferred","_timer","_label","Deferred","setTimeout","clearTimeout","valueOrThrow"],"sources":["../../../../src/common/CallbackRegistry.ts"],"sourcesContent":[null],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"script","externalDependencies":[]}