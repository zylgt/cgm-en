{"ast":null,"code":"\"use strict\";\n\n/**\n * @license\n * Copyright 2023 Google Inc.\n * SPDX-License-Identifier: Apache-2.0\n */\nvar __createBinding = this && this.__createBinding || (Object.create ? function (o, m, k, k2) {\n  if (k2 === undefined) k2 = k;\n  var desc = Object.getOwnPropertyDescriptor(m, k);\n  if (!desc || (\"get\" in desc ? !m.__esModule : desc.writable || desc.configurable)) {\n    desc = {\n      enumerable: true,\n      get: function () {\n        return m[k];\n      }\n    };\n  }\n  Object.defineProperty(o, k2, desc);\n} : function (o, m, k, k2) {\n  if (k2 === undefined) k2 = k;\n  o[k2] = m[k];\n});\nvar __setModuleDefault = this && this.__setModuleDefault || (Object.create ? function (o, v) {\n  Object.defineProperty(o, \"default\", {\n    enumerable: true,\n    value: v\n  });\n} : function (o, v) {\n  o[\"default\"] = v;\n});\nvar __importStar = this && this.__importStar || function (mod) {\n  if (mod && mod.__esModule) return mod;\n  var result = {};\n  if (mod != null) for (var k in mod) if (k !== \"default\" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);\n  __setModuleDefault(result, mod);\n  return result;\n};\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports._connectToBiDiBrowser = void 0;\nconst Connection_js_1 = require(\"../cdp/Connection.js\");\nconst Errors_js_1 = require(\"../common/Errors.js\");\nconst util_js_1 = require(\"../common/util.js\");\n/**\n * Users should never call this directly; it's called when calling `puppeteer.connect`\n * with `protocol: 'webDriverBiDi'`. This method attaches Puppeteer to an existing browser\n * instance. First it tries to connect to the browser using pure BiDi. If the protocol is\n * not supported, connects to the browser using BiDi over CDP.\n *\n * @internal\n */\nasync function _connectToBiDiBrowser(connectionTransport, url, options) {\n  const {\n    ignoreHTTPSErrors = false,\n    defaultViewport = util_js_1.DEFAULT_VIEWPORT\n  } = options;\n  const {\n    bidiConnection,\n    closeCallback\n  } = await getBiDiConnection(connectionTransport, url, options);\n  const BiDi = await Promise.resolve().then(() => __importStar(require( /* webpackIgnore: true */'./bidi.js')));\n  const bidiBrowser = await BiDi.BidiBrowser.create({\n    connection: bidiConnection,\n    closeCallback,\n    process: undefined,\n    defaultViewport: defaultViewport,\n    ignoreHTTPSErrors: ignoreHTTPSErrors\n  });\n  return bidiBrowser;\n}\nexports._connectToBiDiBrowser = _connectToBiDiBrowser;\n/**\n * Returns a BiDiConnection established to the endpoint specified by the options and a\n * callback closing the browser. Callback depends on whether the connection is pure BiDi\n * or BiDi over CDP.\n * The method tries to connect to the browser using pure BiDi protocol, and falls back\n * to BiDi over CDP.\n */\nasync function getBiDiConnection(connectionTransport, url, options) {\n  const BiDi = await Promise.resolve().then(() => __importStar(require( /* webpackIgnore: true */'./bidi.js')));\n  const {\n    ignoreHTTPSErrors = false,\n    slowMo = 0,\n    protocolTimeout\n  } = options;\n  // Try pure BiDi first.\n  const pureBidiConnection = new BiDi.BidiConnection(url, connectionTransport, slowMo, protocolTimeout);\n  try {\n    const result = await pureBidiConnection.send('session.status', {});\n    if ('type' in result && result.type === 'success') {\n      // The `browserWSEndpoint` points to an endpoint supporting pure WebDriver BiDi.\n      return {\n        bidiConnection: pureBidiConnection,\n        closeCallback: async () => {\n          await pureBidiConnection.send('browser.close', {}).catch(util_js_1.debugError);\n        }\n      };\n    }\n  } catch (e) {\n    if (!(e instanceof Errors_js_1.ProtocolError)) {\n      // Unexpected exception not related to BiDi / CDP. Rethrow.\n      throw e;\n    }\n  }\n  // Unbind the connection to avoid memory leaks.\n  pureBidiConnection.unbind();\n  // Fall back to CDP over BiDi reusing the WS connection.\n  const cdpConnection = new Connection_js_1.Connection(url, connectionTransport, slowMo, protocolTimeout);\n  const version = await cdpConnection.send('Browser.getVersion');\n  if (version.product.toLowerCase().includes('firefox')) {\n    throw new Errors_js_1.UnsupportedOperation('Firefox is not supported in BiDi over CDP mode.');\n  }\n  // TODO: use other options too.\n  const bidiOverCdpConnection = await BiDi.connectBidiOverCdp(cdpConnection, {\n    acceptInsecureCerts: ignoreHTTPSErrors\n  });\n  return {\n    bidiConnection: bidiOverCdpConnection,\n    closeCallback: async () => {\n      // In case of BiDi over CDP, we need to close browser via CDP.\n      await cdpConnection.send('Browser.close').catch(util_js_1.debugError);\n    }\n  };\n}","map":{"version":3,"names":["Connection_js_1","require","Errors_js_1","util_js_1","_connectToBiDiBrowser","connectionTransport","url","options","ignoreHTTPSErrors","defaultViewport","DEFAULT_VIEWPORT","bidiConnection","closeCallback","getBiDiConnection","BiDi","Promise","resolve","then","__importStar","bidiBrowser","BidiBrowser","create","connection","process","undefined","exports","slowMo","protocolTimeout","pureBidiConnection","BidiConnection","result","send","type","catch","debugError","e","ProtocolError","unbind","cdpConnection","Connection","version","product","toLowerCase","includes","UnsupportedOperation","bidiOverCdpConnection","connectBidiOverCdp","acceptInsecureCerts"],"sources":["../../../../src/bidi/BrowserConnector.ts"],"sourcesContent":[null],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"script","externalDependencies":[]}