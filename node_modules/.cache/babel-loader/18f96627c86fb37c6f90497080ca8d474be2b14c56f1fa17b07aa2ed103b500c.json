{"ast":null,"code":"\"use strict\";\n\nvar _classPrivateMethodInitSpec = require(\"/Users/hexuemin/Desktop/jiuan/CGM/CGMWeb/node_modules/@babel/runtime/helpers/classPrivateMethodInitSpec.js\").default;\nvar _defineProperty = require(\"/Users/hexuemin/Desktop/jiuan/CGM/CGMWeb/node_modules/@babel/runtime/helpers/defineProperty.js\").default;\nvar _classPrivateFieldInitSpec = require(\"/Users/hexuemin/Desktop/jiuan/CGM/CGMWeb/node_modules/@babel/runtime/helpers/classPrivateFieldInitSpec.js\").default;\nvar _assertClassBrand = require(\"/Users/hexuemin/Desktop/jiuan/CGM/CGMWeb/node_modules/@babel/runtime/helpers/assertClassBrand.js\").default;\nvar _classPrivateFieldGet = require(\"/Users/hexuemin/Desktop/jiuan/CGM/CGMWeb/node_modules/@babel/runtime/helpers/classPrivateFieldGet2.js\").default;\nvar _classPrivateFieldSet = require(\"/Users/hexuemin/Desktop/jiuan/CGM/CGMWeb/node_modules/@babel/runtime/helpers/classPrivateFieldSet2.js\").default;\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.PipeTransport = void 0;\nconst EventEmitter_js_1 = require(\"../common/EventEmitter.js\");\nconst util_js_1 = require(\"../common/util.js\");\nconst assert_js_1 = require(\"../util/assert.js\");\nconst disposable_js_1 = require(\"../util/disposable.js\");\n/**\n * @internal\n */\nvar _pipeWrite = /*#__PURE__*/new WeakMap();\nvar _subscriptions = /*#__PURE__*/new WeakMap();\nvar _isClosed = /*#__PURE__*/new WeakMap();\nvar _pendingMessage = /*#__PURE__*/new WeakMap();\nvar _PipeTransport_brand = /*#__PURE__*/new WeakSet();\nclass PipeTransport {\n  constructor(pipeWrite, pipeRead) {\n    _classPrivateMethodInitSpec(this, _PipeTransport_brand);\n    _classPrivateFieldInitSpec(this, _pipeWrite, void 0);\n    _classPrivateFieldInitSpec(this, _subscriptions, new disposable_js_1.DisposableStack());\n    _classPrivateFieldInitSpec(this, _isClosed, false);\n    _classPrivateFieldInitSpec(this, _pendingMessage, '');\n    _defineProperty(this, \"onclose\", void 0);\n    _defineProperty(this, \"onmessage\", void 0);\n    _classPrivateFieldSet(_pipeWrite, this, pipeWrite);\n    _classPrivateFieldGet(_subscriptions, this).use(new EventEmitter_js_1.EventSubscription(pipeRead, 'data', buffer => {\n      return _assertClassBrand(_PipeTransport_brand, this, _dispatch).call(this, buffer);\n    }));\n    _classPrivateFieldGet(_subscriptions, this).use(new EventEmitter_js_1.EventSubscription(pipeRead, 'close', () => {\n      if (this.onclose) {\n        this.onclose.call(null);\n      }\n    }));\n    _classPrivateFieldGet(_subscriptions, this).use(new EventEmitter_js_1.EventSubscription(pipeRead, 'error', util_js_1.debugError));\n    _classPrivateFieldGet(_subscriptions, this).use(new EventEmitter_js_1.EventSubscription(pipeWrite, 'error', util_js_1.debugError));\n  }\n  send(message) {\n    (0, assert_js_1.assert)(!_classPrivateFieldGet(_isClosed, this), '`PipeTransport` is closed.');\n    _classPrivateFieldGet(_pipeWrite, this).write(message);\n    _classPrivateFieldGet(_pipeWrite, this).write('\\0');\n  }\n  close() {\n    _classPrivateFieldSet(_isClosed, this, true);\n    _classPrivateFieldGet(_subscriptions, this).dispose();\n  }\n}\nfunction _dispatch(buffer) {\n  (0, assert_js_1.assert)(!_classPrivateFieldGet(_isClosed, this), '`PipeTransport` is closed.');\n  let end = buffer.indexOf('\\0');\n  if (end === -1) {\n    _classPrivateFieldSet(_pendingMessage, this, _classPrivateFieldGet(_pendingMessage, this) + buffer.toString());\n    return;\n  }\n  const message = _classPrivateFieldGet(_pendingMessage, this) + buffer.toString(undefined, 0, end);\n  if (this.onmessage) {\n    this.onmessage.call(null, message);\n  }\n  let start = end + 1;\n  end = buffer.indexOf('\\0', start);\n  while (end !== -1) {\n    if (this.onmessage) {\n      this.onmessage.call(null, buffer.toString(undefined, start, end));\n    }\n    start = end + 1;\n    end = buffer.indexOf('\\0', start);\n  }\n  _classPrivateFieldSet(_pendingMessage, this, buffer.toString(undefined, start));\n}\nexports.PipeTransport = PipeTransport;","map":{"version":3,"names":["EventEmitter_js_1","require","util_js_1","assert_js_1","disposable_js_1","_pipeWrite","WeakMap","_subscriptions","_isClosed","_pendingMessage","_PipeTransport_brand","WeakSet","PipeTransport","constructor","pipeWrite","pipeRead","_classPrivateMethodInitSpec","_classPrivateFieldInitSpec","DisposableStack","_defineProperty","_classPrivateFieldSet","_classPrivateFieldGet","use","EventSubscription","buffer","_assertClassBrand","_dispatch","call","onclose","debugError","send","message","assert","write","close","dispose","end","indexOf","toString","undefined","onmessage","start","exports"],"sources":["../../../../src/node/PipeTransport.ts"],"sourcesContent":[null],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"script","externalDependencies":[]}