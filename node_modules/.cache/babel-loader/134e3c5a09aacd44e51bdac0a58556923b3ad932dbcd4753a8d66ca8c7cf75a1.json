{"ast":null,"code":"import _classPrivateMethodInitSpec from \"/Users/hexuemin/Desktop/jiuan/CGM/CGMWeb/node_modules/@babel/runtime/helpers/esm/classPrivateMethodInitSpec.js\";\nimport _classPrivateFieldInitSpec from \"/Users/hexuemin/Desktop/jiuan/CGM/CGMWeb/node_modules/@babel/runtime/helpers/esm/classPrivateFieldInitSpec.js\";\nimport _assertClassBrand from \"/Users/hexuemin/Desktop/jiuan/CGM/CGMWeb/node_modules/@babel/runtime/helpers/esm/assertClassBrand.js\";\nimport _classPrivateFieldSet from \"/Users/hexuemin/Desktop/jiuan/CGM/CGMWeb/node_modules/@babel/runtime/helpers/esm/classPrivateFieldSet2.js\";\nimport _classPrivateFieldGet from \"/Users/hexuemin/Desktop/jiuan/CGM/CGMWeb/node_modules/@babel/runtime/helpers/esm/classPrivateFieldGet2.js\";\n/**\n * @license\n * Copyright 2024 Google Inc.\n * SPDX-License-Identifier: Apache-2.0\n */\nimport { TimeoutError } from '../common/Errors.js';\n/**\n * Creates and returns a deferred object along with the resolve/reject functions.\n *\n * If the deferred has not been resolved/rejected within the `timeout` period,\n * the deferred gets resolves with a timeout error. `timeout` has to be greater than 0 or\n * it is ignored.\n *\n * @internal\n */\nvar _isResolved = /*#__PURE__*/new WeakMap();\nvar _isRejected = /*#__PURE__*/new WeakMap();\nvar _value = /*#__PURE__*/new WeakMap();\nvar _resolve = /*#__PURE__*/new WeakMap();\nvar _taskPromise = /*#__PURE__*/new WeakMap();\nvar _timeoutId = /*#__PURE__*/new WeakMap();\nvar _timeoutError = /*#__PURE__*/new WeakMap();\nvar _Deferred_brand = /*#__PURE__*/new WeakSet();\nvar _promise = /*#__PURE__*/new WeakMap();\nexport class Deferred {\n  static create(opts) {\n    return new Deferred(opts);\n  }\n  static async race(awaitables) {\n    const deferredWithTimeout = new Set();\n    try {\n      const promises = awaitables.map(value => {\n        if (value instanceof Deferred) {\n          if (_classPrivateFieldGet(_timeoutId, value)) {\n            deferredWithTimeout.add(value);\n          }\n          return value.valueOrThrow();\n        }\n        return value;\n      });\n      // eslint-disable-next-line no-restricted-syntax\n      return await Promise.race(promises);\n    } finally {\n      for (const deferred of deferredWithTimeout) {\n        // We need to stop the timeout else\n        // Node.JS will keep running the event loop till the\n        // timer executes\n        deferred.reject(new Error('Timeout cleared'));\n      }\n    }\n  }\n  constructor(opts) {\n    _classPrivateMethodInitSpec(this, _Deferred_brand);\n    _classPrivateFieldInitSpec(this, _isResolved, false);\n    _classPrivateFieldInitSpec(this, _isRejected, false);\n    _classPrivateFieldInitSpec(this, _value, void 0);\n    // SAFETY: This is ensured by #taskPromise.\n    _classPrivateFieldInitSpec(this, _resolve, void 0);\n    _classPrivateFieldInitSpec(this, _taskPromise, new Promise(resolve => {\n      _classPrivateFieldSet(_resolve, this, resolve);\n    }));\n    _classPrivateFieldInitSpec(this, _timeoutId, void 0);\n    _classPrivateFieldInitSpec(this, _timeoutError, void 0);\n    _classPrivateFieldInitSpec(this, _promise, void 0);\n    if (opts && opts.timeout > 0) {\n      _classPrivateFieldSet(_timeoutError, this, new TimeoutError(opts.message));\n      _classPrivateFieldSet(_timeoutId, this, setTimeout(() => {\n        this.reject(_classPrivateFieldGet(_timeoutError, this));\n      }, opts.timeout));\n    }\n  }\n  resolve(value) {\n    if (_classPrivateFieldGet(_isRejected, this) || _classPrivateFieldGet(_isResolved, this)) {\n      return;\n    }\n    _classPrivateFieldSet(_isResolved, this, true);\n    _assertClassBrand(_Deferred_brand, this, _finish).call(this, value);\n  }\n  reject(error) {\n    if (_classPrivateFieldGet(_isRejected, this) || _classPrivateFieldGet(_isResolved, this)) {\n      return;\n    }\n    _classPrivateFieldSet(_isRejected, this, true);\n    _assertClassBrand(_Deferred_brand, this, _finish).call(this, error);\n  }\n  resolved() {\n    return _classPrivateFieldGet(_isResolved, this);\n  }\n  finished() {\n    return _classPrivateFieldGet(_isResolved, this) || _classPrivateFieldGet(_isRejected, this);\n  }\n  value() {\n    return _classPrivateFieldGet(_value, this);\n  }\n  valueOrThrow() {\n    if (!_classPrivateFieldGet(_promise, this)) {\n      _classPrivateFieldSet(_promise, this, (async () => {\n        await _classPrivateFieldGet(_taskPromise, this);\n        if (_classPrivateFieldGet(_isRejected, this)) {\n          throw _classPrivateFieldGet(_value, this);\n        }\n        return _classPrivateFieldGet(_value, this);\n      })());\n    }\n    return _classPrivateFieldGet(_promise, this);\n  }\n}\nfunction _finish(value) {\n  clearTimeout(_classPrivateFieldGet(_timeoutId, this));\n  _classPrivateFieldSet(_value, this, value);\n  _classPrivateFieldGet(_resolve, this).call(this);\n}","map":{"version":3,"names":["TimeoutError","_isResolved","WeakMap","_isRejected","_value","_resolve","_taskPromise","_timeoutId","_timeoutError","_Deferred_brand","WeakSet","_promise","Deferred","create","opts","race","awaitables","deferredWithTimeout","Set","promises","map","value","_classPrivateFieldGet","add","valueOrThrow","Promise","deferred","reject","Error","constructor","_classPrivateMethodInitSpec","_classPrivateFieldInitSpec","resolve","_classPrivateFieldSet","timeout","message","setTimeout","_assertClassBrand","_finish","call","error","resolved","finished","clearTimeout"],"sources":["../../../../src/util/Deferred.ts"],"sourcesContent":[null],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}