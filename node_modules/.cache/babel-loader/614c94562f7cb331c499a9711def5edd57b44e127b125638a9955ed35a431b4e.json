{"ast":null,"code":"\"use strict\";\n\n/**\n * Copyright 2023 Google LLC.\n * Copyright (c) Microsoft Corporation.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nvar _classPrivateMethodInitSpec = require(\"/Users/hexuemin/Desktop/jiuan/CGM/CGMWeb/node_modules/@babel/runtime/helpers/classPrivateMethodInitSpec.js\").default;\nvar _classPrivateFieldInitSpec = require(\"/Users/hexuemin/Desktop/jiuan/CGM/CGMWeb/node_modules/@babel/runtime/helpers/classPrivateFieldInitSpec.js\").default;\nvar _assertClassBrand = require(\"/Users/hexuemin/Desktop/jiuan/CGM/CGMWeb/node_modules/@babel/runtime/helpers/assertClassBrand.js\").default;\nvar _classPrivateFieldGet = require(\"/Users/hexuemin/Desktop/jiuan/CGM/CGMWeb/node_modules/@babel/runtime/helpers/classPrivateFieldGet2.js\").default;\nvar _classPrivateFieldSet = require(\"/Users/hexuemin/Desktop/jiuan/CGM/CGMWeb/node_modules/@babel/runtime/helpers/classPrivateFieldSet2.js\").default;\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.ScriptProcessor = void 0;\nconst protocol_js_1 = require(\"../../../protocol/protocol.js\");\nconst PreloadScript_js_1 = require(\"./PreloadScript.js\");\nvar _browsingContextStorage = /*#__PURE__*/new WeakMap();\nvar _realmStorage = /*#__PURE__*/new WeakMap();\nvar _preloadScriptStorage = /*#__PURE__*/new WeakMap();\nvar _logger = /*#__PURE__*/new WeakMap();\nvar _ScriptProcessor_brand = /*#__PURE__*/new WeakSet();\nclass ScriptProcessor {\n  constructor(browsingContextStorage, realmStorage, preloadScriptStorage, logger) {\n    _classPrivateMethodInitSpec(this, _ScriptProcessor_brand);\n    _classPrivateFieldInitSpec(this, _browsingContextStorage, void 0);\n    _classPrivateFieldInitSpec(this, _realmStorage, void 0);\n    _classPrivateFieldInitSpec(this, _preloadScriptStorage, void 0);\n    _classPrivateFieldInitSpec(this, _logger, void 0);\n    _classPrivateFieldSet(_browsingContextStorage, this, browsingContextStorage);\n    _classPrivateFieldSet(_realmStorage, this, realmStorage);\n    _classPrivateFieldSet(_preloadScriptStorage, this, preloadScriptStorage);\n    _classPrivateFieldSet(_logger, this, logger);\n  }\n  async addPreloadScript(params) {\n    const contexts = _classPrivateFieldGet(_browsingContextStorage, this).verifyTopLevelContextsList(params.contexts);\n    const preloadScript = new PreloadScript_js_1.PreloadScript(params, _classPrivateFieldGet(_logger, this));\n    _classPrivateFieldGet(_preloadScriptStorage, this).add(preloadScript);\n    const cdpTargets = contexts.size === 0 ? new Set(_classPrivateFieldGet(_browsingContextStorage, this).getTopLevelContexts().map(context => context.cdpTarget)) : new Set([...contexts.values()].map(context => context.cdpTarget));\n    await preloadScript.initInTargets(cdpTargets, false);\n    return {\n      script: preloadScript.id\n    };\n  }\n  async removePreloadScript(params) {\n    const {\n      script: id\n    } = params;\n    const scripts = _classPrivateFieldGet(_preloadScriptStorage, this).find({\n      id\n    });\n    if (scripts.length === 0) {\n      throw new protocol_js_1.NoSuchScriptException(`No preload script with id '${id}'`);\n    }\n    await Promise.all(scripts.map(script => script.remove()));\n    _classPrivateFieldGet(_preloadScriptStorage, this).remove({\n      id\n    });\n    return {};\n  }\n  async callFunction(params) {\n    const realm = await _assertClassBrand(_ScriptProcessor_brand, this, _getRealm).call(this, params.target);\n    return await realm.callFunction(params.functionDeclaration, params.awaitPromise, params.this, params.arguments, params.resultOwnership, params.serializationOptions, params.userActivation);\n  }\n  async evaluate(params) {\n    const realm = await _assertClassBrand(_ScriptProcessor_brand, this, _getRealm).call(this, params.target);\n    return await realm.evaluate(params.expression, params.awaitPromise, params.resultOwnership, params.serializationOptions, params.userActivation);\n  }\n  async disown(params) {\n    const realm = await _assertClassBrand(_ScriptProcessor_brand, this, _getRealm).call(this, params.target);\n    await Promise.all(params.handles.map(async handle => await realm.disown(handle)));\n    return {};\n  }\n  getRealms(params) {\n    if (params.context !== undefined) {\n      // Make sure the context is known.\n      _classPrivateFieldGet(_browsingContextStorage, this).getContext(params.context);\n    }\n    const realms = _classPrivateFieldGet(_realmStorage, this).findRealms({\n      browsingContextId: params.context,\n      type: params.type\n    }).map(realm => realm.realmInfo);\n    return {\n      realms\n    };\n  }\n}\nasync function _getRealm(target) {\n  if ('context' in target) {\n    const context = _classPrivateFieldGet(_browsingContextStorage, this).getContext(target.context);\n    return await context.getOrCreateSandbox(target.sandbox);\n  }\n  return _classPrivateFieldGet(_realmStorage, this).getRealm({\n    realmId: target.realm\n  });\n}\nexports.ScriptProcessor = ScriptProcessor;","map":{"version":3,"names":["_classPrivateMethodInitSpec","require","default","_classPrivateFieldInitSpec","_assertClassBrand","_classPrivateFieldGet","_classPrivateFieldSet","protocol_js_1","PreloadScript_js_1","_browsingContextStorage","WeakMap","_realmStorage","_preloadScriptStorage","_logger","_ScriptProcessor_brand","WeakSet","ScriptProcessor","constructor","browsingContextStorage","realmStorage","preloadScriptStorage","logger","addPreloadScript","params","contexts","verifyTopLevelContextsList","preloadScript","PreloadScript","add","cdpTargets","size","Set","getTopLevelContexts","map","context","cdpTarget","values","initInTargets","script","id","removePreloadScript","scripts","find","length","NoSuchScriptException","Promise","all","remove","callFunction","realm","_getRealm","call","target","functionDeclaration","awaitPromise","this","arguments","resultOwnership","serializationOptions","userActivation","evaluate","expression","disown","handles","handle","getRealms","undefined","getContext","realms","findRealms","browsingContextId","type","realmInfo","getOrCreateSandbox","sandbox","getRealm","realmId","exports"],"sources":["../../../../../src/bidiMapper/modules/script/ScriptProcessor.ts"],"sourcesContent":[null],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"script","externalDependencies":[]}