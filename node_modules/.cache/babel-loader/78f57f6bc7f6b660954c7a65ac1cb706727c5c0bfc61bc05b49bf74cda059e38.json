{"ast":null,"code":"\"use strict\";\n\nvar _classPrivateFieldInitSpec = require(\"/Users/hexuemin/Desktop/jiuan/CGM/CGMWeb/node_modules/@babel/runtime/helpers/classPrivateFieldInitSpec.js\").default;\nvar _classPrivateFieldGet = require(\"/Users/hexuemin/Desktop/jiuan/CGM/CGMWeb/node_modules/@babel/runtime/helpers/classPrivateFieldGet2.js\").default;\nvar _classPrivateFieldSet = require(\"/Users/hexuemin/Desktop/jiuan/CGM/CGMWeb/node_modules/@babel/runtime/helpers/classPrivateFieldSet2.js\").default;\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.BrowsingContextProcessor = void 0;\nconst protocol_js_1 = require(\"../../../protocol/protocol.js\");\nvar _browserCdpClient = /*#__PURE__*/new WeakMap();\nvar _browsingContextStorage = /*#__PURE__*/new WeakMap();\nclass BrowsingContextProcessor {\n  constructor(browserCdpClient, browsingContextStorage) {\n    _classPrivateFieldInitSpec(this, _browserCdpClient, void 0);\n    _classPrivateFieldInitSpec(this, _browsingContextStorage, void 0);\n    _classPrivateFieldSet(_browserCdpClient, this, browserCdpClient);\n    _classPrivateFieldSet(_browsingContextStorage, this, browsingContextStorage);\n  }\n  getTree(params) {\n    const resultContexts = params.root === undefined ? _classPrivateFieldGet(_browsingContextStorage, this).getTopLevelContexts() : [_classPrivateFieldGet(_browsingContextStorage, this).getContext(params.root)];\n    return {\n      contexts: resultContexts.map(c => c.serializeToBidiValue(params.maxDepth ?? Number.MAX_VALUE))\n    };\n  }\n  async create(params) {\n    let referenceContext;\n    let userContext = 'default';\n    if (params.referenceContext !== undefined) {\n      referenceContext = _classPrivateFieldGet(_browsingContextStorage, this).getContext(params.referenceContext);\n      if (!referenceContext.isTopLevelContext()) {\n        throw new protocol_js_1.InvalidArgumentException(`referenceContext should be a top-level context`);\n      }\n      userContext = referenceContext.userContext;\n    }\n    if (params.userContext !== undefined) {\n      userContext = params.userContext;\n    }\n    const existingContexts = _classPrivateFieldGet(_browsingContextStorage, this).getAllContexts().filter(context => context.userContext === userContext);\n    let newWindow = false;\n    switch (params.type) {\n      case \"tab\" /* BrowsingContext.CreateType.Tab */:\n        newWindow = false;\n        break;\n      case \"window\" /* BrowsingContext.CreateType.Window */:\n        newWindow = true;\n        break;\n    }\n    if (!existingContexts.length) {\n      // If there are no contexts in the given user context, we need to set\n      // newWindow to true as newWindow=false will be rejected.\n      newWindow = true;\n    }\n    let result;\n    try {\n      result = await _classPrivateFieldGet(_browserCdpClient, this).sendCommand('Target.createTarget', {\n        url: 'about:blank',\n        newWindow,\n        browserContextId: userContext === 'default' ? undefined : userContext\n      });\n    } catch (err) {\n      if (\n      // See https://source.chromium.org/chromium/chromium/src/+/main:chrome/browser/devtools/protocol/target_handler.cc;l=90;drc=e80392ac11e48a691f4309964cab83a3a59e01c8\n      err.message.startsWith('Failed to find browser context with id') ||\n      // See https://source.chromium.org/chromium/chromium/src/+/main:headless/lib/browser/protocol/target_handler.cc;l=49;drc=e80392ac11e48a691f4309964cab83a3a59e01c8\n      err.message === 'browserContextId') {\n        throw new protocol_js_1.NoSuchUserContextException(`The context ${userContext} was not found`);\n      }\n      throw err;\n    }\n    // Wait for the new tab to be loaded to avoid race conditions in the\n    // `browsingContext` events, when the `browsingContext.domContentLoaded` and\n    // `browsingContext.load` events from the initial `about:blank` navigation\n    // are emitted after the next navigation is started.\n    // Details: https://github.com/web-platform-tests/wpt/issues/35846\n    const contextId = result.targetId;\n    const context = _classPrivateFieldGet(_browsingContextStorage, this).getContext(contextId);\n    await context.lifecycleLoaded();\n    return {\n      context: context.id\n    };\n  }\n  navigate(params) {\n    const context = _classPrivateFieldGet(_browsingContextStorage, this).getContext(params.context);\n    return context.navigate(params.url, params.wait ?? \"none\" /* BrowsingContext.ReadinessState.None */);\n  }\n  reload(params) {\n    const context = _classPrivateFieldGet(_browsingContextStorage, this).getContext(params.context);\n    return context.reload(params.ignoreCache ?? false, params.wait ?? \"none\" /* BrowsingContext.ReadinessState.None */);\n  }\n  async activate(params) {\n    const context = _classPrivateFieldGet(_browsingContextStorage, this).getContext(params.context);\n    if (!context.isTopLevelContext()) {\n      throw new protocol_js_1.InvalidArgumentException('Activation is only supported on the top-level context');\n    }\n    await context.activate();\n    return {};\n  }\n  async captureScreenshot(params) {\n    const context = _classPrivateFieldGet(_browsingContextStorage, this).getContext(params.context);\n    return await context.captureScreenshot(params);\n  }\n  async print(params) {\n    const context = _classPrivateFieldGet(_browsingContextStorage, this).getContext(params.context);\n    return await context.print(params);\n  }\n  async setViewport(params) {\n    const context = _classPrivateFieldGet(_browsingContextStorage, this).getContext(params.context);\n    if (!context.isTopLevelContext()) {\n      throw new protocol_js_1.InvalidArgumentException('Emulating viewport is only supported on the top-level context');\n    }\n    await context.setViewport(params.viewport, params.devicePixelRatio);\n    return {};\n  }\n  async traverseHistory(params) {\n    const context = _classPrivateFieldGet(_browsingContextStorage, this).getContext(params.context);\n    if (!context) {\n      throw new protocol_js_1.InvalidArgumentException(`No browsing context with id ${params.context}`);\n    }\n    await context.traverseHistory(params.delta);\n    return {};\n  }\n  async handleUserPrompt(params) {\n    const context = _classPrivateFieldGet(_browsingContextStorage, this).getContext(params.context);\n    try {\n      await context.handleUserPrompt(params);\n    } catch (error) {\n      // Heuristically determine the error\n      // https://source.chromium.org/chromium/chromium/src/+/main:content/browser/devtools/protocol/page_handler.cc;l=1085?q=%22No%20dialog%20is%20showing%22&ss=chromium\n      if (error.message?.includes('No dialog is showing')) {\n        throw new protocol_js_1.NoSuchAlertException('No dialog is showing');\n      }\n      throw error;\n    }\n    return {};\n  }\n  async close(params) {\n    const context = _classPrivateFieldGet(_browsingContextStorage, this).getContext(params.context);\n    if (!context.isTopLevelContext()) {\n      throw new protocol_js_1.InvalidArgumentException(`Non top-level browsing context ${context.id} cannot be closed.`);\n    }\n    try {\n      const detachedFromTargetPromise = new Promise(resolve => {\n        const onContextDestroyed = event => {\n          if (event.targetId === params.context) {\n            _classPrivateFieldGet(_browserCdpClient, this).off('Target.detachedFromTarget', onContextDestroyed);\n            resolve();\n          }\n        };\n        _classPrivateFieldGet(_browserCdpClient, this).on('Target.detachedFromTarget', onContextDestroyed);\n      });\n      if (params.promptUnload) {\n        await context.close();\n      } else {\n        await _classPrivateFieldGet(_browserCdpClient, this).sendCommand('Target.closeTarget', {\n          targetId: params.context\n        });\n      }\n      // Sometimes CDP command finishes before `detachedFromTarget` event,\n      // sometimes after. Wait for the CDP command to be finished, and then wait\n      // for `detachedFromTarget` if it hasn't emitted.\n      await detachedFromTargetPromise;\n    } catch (error) {\n      // Swallow error that arise from the page being destroyed\n      // Example is navigating to faulty SSL certificate\n      if (!(error.code === -32000 /* CdpErrorConstants.GENERIC_ERROR */ && error.message === 'Not attached to an active page')) {\n        throw error;\n      }\n    }\n    return {};\n  }\n  async locateNodes(params) {\n    const context = _classPrivateFieldGet(_browsingContextStorage, this).getContext(params.context);\n    return await context.locateNodes(params);\n  }\n}\nexports.BrowsingContextProcessor = BrowsingContextProcessor;","map":{"version":3,"names":["protocol_js_1","require","_browserCdpClient","WeakMap","_browsingContextStorage","BrowsingContextProcessor","constructor","browserCdpClient","browsingContextStorage","_classPrivateFieldInitSpec","_classPrivateFieldSet","getTree","params","resultContexts","root","undefined","_classPrivateFieldGet","getTopLevelContexts","getContext","contexts","map","c","serializeToBidiValue","maxDepth","Number","MAX_VALUE","create","referenceContext","userContext","isTopLevelContext","InvalidArgumentException","existingContexts","getAllContexts","filter","context","newWindow","type","length","result","sendCommand","url","browserContextId","err","message","startsWith","NoSuchUserContextException","contextId","targetId","lifecycleLoaded","id","navigate","wait","reload","ignoreCache","activate","captureScreenshot","print","setViewport","viewport","devicePixelRatio","traverseHistory","delta","handleUserPrompt","error","includes","NoSuchAlertException","close","detachedFromTargetPromise","Promise","resolve","onContextDestroyed","event","off","on","promptUnload","code","locateNodes","exports"],"sources":["../../../../../src/bidiMapper/modules/context/BrowsingContextProcessor.ts"],"sourcesContent":[null],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"script","externalDependencies":[]}