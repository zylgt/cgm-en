{"ast":null,"code":"\"use strict\";\n\n/**\n * @license\n * Copyright 2017 Google Inc.\n * SPDX-License-Identifier: Apache-2.0\n */\nvar _classPrivateFieldInitSpec = require(\"/Users/hexuemin/Desktop/jiuan/CGM/CGMWeb/node_modules/@babel/runtime/helpers/classPrivateFieldInitSpec.js\").default;\nvar _classPrivateFieldGet = require(\"/Users/hexuemin/Desktop/jiuan/CGM/CGMWeb/node_modules/@babel/runtime/helpers/classPrivateFieldGet2.js\").default;\nvar _classPrivateFieldSet = require(\"/Users/hexuemin/Desktop/jiuan/CGM/CGMWeb/node_modules/@babel/runtime/helpers/classPrivateFieldSet2.js\").default;\nrequire(\"core-js/modules/es.array.push.js\");\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.BidiConnection = void 0;\nconst CallbackRegistry_js_1 = require(\"../common/CallbackRegistry.js\");\nconst Debug_js_1 = require(\"../common/Debug.js\");\nconst EventEmitter_js_1 = require(\"../common/EventEmitter.js\");\nconst util_js_1 = require(\"../common/util.js\");\nconst assert_js_1 = require(\"../util/assert.js\");\nconst CDPSession_js_1 = require(\"./CDPSession.js\");\nconst debugProtocolSend = (0, Debug_js_1.debug)('puppeteer:webDriverBiDi:SEND ►');\nconst debugProtocolReceive = (0, Debug_js_1.debug)('puppeteer:webDriverBiDi:RECV ◀');\n/**\n * @internal\n */\nvar _url = /*#__PURE__*/new WeakMap();\nvar _transport = /*#__PURE__*/new WeakMap();\nvar _delay = /*#__PURE__*/new WeakMap();\nvar _timeout = /*#__PURE__*/new WeakMap();\nvar _closed = /*#__PURE__*/new WeakMap();\nvar _callbacks = /*#__PURE__*/new WeakMap();\nvar _emitters = /*#__PURE__*/new WeakMap();\nclass BidiConnection extends EventEmitter_js_1.EventEmitter {\n  constructor(url, transport, delay = 0, timeout) {\n    super();\n    _classPrivateFieldInitSpec(this, _url, void 0);\n    _classPrivateFieldInitSpec(this, _transport, void 0);\n    _classPrivateFieldInitSpec(this, _delay, void 0);\n    _classPrivateFieldInitSpec(this, _timeout, 0);\n    _classPrivateFieldInitSpec(this, _closed, false);\n    _classPrivateFieldInitSpec(this, _callbacks, new CallbackRegistry_js_1.CallbackRegistry());\n    _classPrivateFieldInitSpec(this, _emitters, []);\n    _classPrivateFieldSet(_url, this, url);\n    _classPrivateFieldSet(_delay, this, delay);\n    _classPrivateFieldSet(_timeout, this, timeout ?? 180000);\n    _classPrivateFieldSet(_transport, this, transport);\n    _classPrivateFieldGet(_transport, this).onmessage = this.onMessage.bind(this);\n    _classPrivateFieldGet(_transport, this).onclose = this.unbind.bind(this);\n  }\n  get closed() {\n    return _classPrivateFieldGet(_closed, this);\n  }\n  get url() {\n    return _classPrivateFieldGet(_url, this);\n  }\n  pipeTo(emitter) {\n    _classPrivateFieldGet(_emitters, this).push(emitter);\n  }\n  emit(type, event) {\n    for (const emitter of _classPrivateFieldGet(_emitters, this)) {\n      emitter.emit(type, event);\n    }\n    return super.emit(type, event);\n  }\n  send(method, params, timeout) {\n    (0, assert_js_1.assert)(!_classPrivateFieldGet(_closed, this), 'Protocol error: Connection closed.');\n    return _classPrivateFieldGet(_callbacks, this).create(method, timeout ?? _classPrivateFieldGet(_timeout, this), id => {\n      const stringifiedMessage = JSON.stringify({\n        id,\n        method,\n        params\n      });\n      debugProtocolSend(stringifiedMessage);\n      _classPrivateFieldGet(_transport, this).send(stringifiedMessage);\n    });\n  }\n  /**\n   * @internal\n   */\n  async onMessage(message) {\n    if (_classPrivateFieldGet(_delay, this)) {\n      await new Promise(f => {\n        return setTimeout(f, _classPrivateFieldGet(_delay, this));\n      });\n    }\n    debugProtocolReceive(message);\n    const object = JSON.parse(message);\n    if ('type' in object) {\n      switch (object.type) {\n        case 'success':\n          _classPrivateFieldGet(_callbacks, this).resolve(object.id, object);\n          return;\n        case 'error':\n          if (object.id === null) {\n            break;\n          }\n          _classPrivateFieldGet(_callbacks, this).reject(object.id, createProtocolError(object), object.message);\n          return;\n        case 'event':\n          if (isCdpEvent(object)) {\n            CDPSession_js_1.BidiCdpSession.sessions.get(object.params.session)?.emit(object.params.event, object.params.params);\n            return;\n          }\n          // SAFETY: We know the method and parameter still match here.\n          this.emit(object.method, object.params);\n          return;\n      }\n    }\n    // Even if the response in not in BiDi protocol format but `id` is provided, reject\n    // the callback. This can happen if the endpoint supports CDP instead of BiDi.\n    if ('id' in object) {\n      _classPrivateFieldGet(_callbacks, this).reject(object.id, `Protocol Error. Message is not in BiDi protocol format: '${message}'`, object.message);\n    }\n    (0, util_js_1.debugError)(object);\n  }\n  /**\n   * Unbinds the connection, but keeps the transport open. Useful when the transport will\n   * be reused by other connection e.g. with different protocol.\n   * @internal\n   */\n  unbind() {\n    if (_classPrivateFieldGet(_closed, this)) {\n      return;\n    }\n    _classPrivateFieldSet(_closed, this, true);\n    // Both may still be invoked and produce errors\n    _classPrivateFieldGet(_transport, this).onmessage = () => {};\n    _classPrivateFieldGet(_transport, this).onclose = () => {};\n    _classPrivateFieldGet(_callbacks, this).clear();\n  }\n  /**\n   * Unbinds the connection and closes the transport.\n   */\n  dispose() {\n    this.unbind();\n    _classPrivateFieldGet(_transport, this).close();\n  }\n  getPendingProtocolErrors() {\n    return _classPrivateFieldGet(_callbacks, this).getPendingProtocolErrors();\n  }\n}\nexports.BidiConnection = BidiConnection;\n/**\n * @internal\n */\nfunction createProtocolError(object) {\n  let message = `${object.error} ${object.message}`;\n  if (object.stacktrace) {\n    message += ` ${object.stacktrace}`;\n  }\n  return message;\n}\nfunction isCdpEvent(event) {\n  return event.method.startsWith('cdp.');\n}","map":{"version":3,"names":["_classPrivateFieldInitSpec","require","default","_classPrivateFieldGet","_classPrivateFieldSet","CallbackRegistry_js_1","Debug_js_1","EventEmitter_js_1","util_js_1","assert_js_1","CDPSession_js_1","debugProtocolSend","debug","debugProtocolReceive","_url","WeakMap","_transport","_delay","_timeout","_closed","_callbacks","_emitters","BidiConnection","EventEmitter","constructor","url","transport","delay","timeout","CallbackRegistry","onmessage","onMessage","bind","onclose","unbind","closed","pipeTo","emitter","push","emit","type","event","send","method","params","assert","create","id","stringifiedMessage","JSON","stringify","message","Promise","f","setTimeout","object","parse","resolve","reject","createProtocolError","isCdpEvent","BidiCdpSession","sessions","get","session","debugError","clear","dispose","close","getPendingProtocolErrors","exports","error","stacktrace","startsWith"],"sources":["../../../../src/bidi/Connection.ts"],"sourcesContent":[null],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"script","externalDependencies":[]}