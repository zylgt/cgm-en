{"ast":null,"code":"\"use strict\";\n\n/**\n * @license\n * Copyright 2023 Google Inc.\n * SPDX-License-Identifier: Apache-2.0\n */\nvar _defineProperty = require(\"/Users/hexuemin/Desktop/jiuan/CGM/CGMWeb/node_modules/@babel/runtime/helpers/defineProperty.js\").default;\nvar _classPrivateFieldInitSpec = require(\"/Users/hexuemin/Desktop/jiuan/CGM/CGMWeb/node_modules/@babel/runtime/helpers/classPrivateFieldInitSpec.js\").default;\nvar _classPrivateFieldGet = require(\"/Users/hexuemin/Desktop/jiuan/CGM/CGMWeb/node_modules/@babel/runtime/helpers/classPrivateFieldGet2.js\").default;\nvar _classPrivateFieldSet = require(\"/Users/hexuemin/Desktop/jiuan/CGM/CGMWeb/node_modules/@babel/runtime/helpers/classPrivateFieldSet2.js\").default;\nvar __createBinding = this && this.__createBinding || (Object.create ? function (o, m, k, k2) {\n  if (k2 === undefined) k2 = k;\n  var desc = Object.getOwnPropertyDescriptor(m, k);\n  if (!desc || (\"get\" in desc ? !m.__esModule : desc.writable || desc.configurable)) {\n    desc = {\n      enumerable: true,\n      get: function () {\n        return m[k];\n      }\n    };\n  }\n  Object.defineProperty(o, k2, desc);\n} : function (o, m, k, k2) {\n  if (k2 === undefined) k2 = k;\n  o[k2] = m[k];\n});\nvar __setModuleDefault = this && this.__setModuleDefault || (Object.create ? function (o, v) {\n  Object.defineProperty(o, \"default\", {\n    enumerable: true,\n    value: v\n  });\n} : function (o, v) {\n  o[\"default\"] = v;\n});\nvar __importStar = this && this.__importStar || function (mod) {\n  if (mod && mod.__esModule) return mod;\n  var result = {};\n  if (mod != null) for (var k in mod) if (k !== \"default\" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);\n  __setModuleDefault(result, mod);\n  return result;\n};\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.connectBidiOverCdp = void 0;\nconst BidiMapper = __importStar(require(\"chromium-bidi/lib/cjs/bidiMapper/BidiMapper.js\"));\nconst Debug_js_1 = require(\"../common/Debug.js\");\nconst Errors_js_1 = require(\"../common/Errors.js\");\nconst Connection_js_1 = require(\"./Connection.js\");\nconst bidiServerLogger = (prefix, ...args) => {\n  (0, Debug_js_1.debug)(`bidi:${prefix}`)(args);\n};\n/**\n * @internal\n */\nasync function connectBidiOverCdp(cdp, options) {\n  const transportBiDi = new NoOpTransport();\n  const cdpConnectionAdapter = new CdpConnectionAdapter(cdp);\n  const pptrTransport = {\n    send(message) {\n      // Forwards a BiDi command sent by Puppeteer to the input of the BidiServer.\n      transportBiDi.emitMessage(JSON.parse(message));\n    },\n    close() {\n      bidiServer.close();\n      cdpConnectionAdapter.close();\n      cdp.dispose();\n    },\n    onmessage(_message) {\n      // The method is overridden by the Connection.\n    }\n  };\n  transportBiDi.on('bidiResponse', message => {\n    // Forwards a BiDi event sent by BidiServer to Puppeteer.\n    pptrTransport.onmessage(JSON.stringify(message));\n  });\n  const pptrBiDiConnection = new Connection_js_1.BidiConnection(cdp.url(), pptrTransport, cdp.delay, cdp.timeout);\n  const bidiServer = await BidiMapper.BidiServer.createAndStart(transportBiDi, cdpConnectionAdapter,\n  // TODO: most likely need a little bit of refactoring\n  cdpConnectionAdapter.browserClient(), '', options, undefined, bidiServerLogger);\n  return pptrBiDiConnection;\n}\nexports.connectBidiOverCdp = connectBidiOverCdp;\n/**\n * Manages CDPSessions for BidiServer.\n * @internal\n */\nvar _cdp = /*#__PURE__*/new WeakMap();\nvar _adapters = /*#__PURE__*/new WeakMap();\nvar _browserCdpConnection = /*#__PURE__*/new WeakMap();\nclass CdpConnectionAdapter {\n  constructor(cdp) {\n    _classPrivateFieldInitSpec(this, _cdp, void 0);\n    _classPrivateFieldInitSpec(this, _adapters, new Map());\n    _classPrivateFieldInitSpec(this, _browserCdpConnection, void 0);\n    _classPrivateFieldSet(_cdp, this, cdp);\n    _classPrivateFieldSet(_browserCdpConnection, this, new CDPClientAdapter(cdp));\n  }\n  browserClient() {\n    return _classPrivateFieldGet(_browserCdpConnection, this);\n  }\n  getCdpClient(id) {\n    const session = _classPrivateFieldGet(_cdp, this).session(id);\n    if (!session) {\n      throw new Error(`Unknown CDP session with id ${id}`);\n    }\n    if (!_classPrivateFieldGet(_adapters, this).has(session)) {\n      const adapter = new CDPClientAdapter(session, id, _classPrivateFieldGet(_browserCdpConnection, this));\n      _classPrivateFieldGet(_adapters, this).set(session, adapter);\n      return adapter;\n    }\n    return _classPrivateFieldGet(_adapters, this).get(session);\n  }\n  close() {\n    _classPrivateFieldGet(_browserCdpConnection, this).close();\n    for (const adapter of _classPrivateFieldGet(_adapters, this).values()) {\n      adapter.close();\n    }\n  }\n}\n/**\n * Wrapper on top of CDPSession/CDPConnection to satisfy CDP interface that\n * BidiServer needs.\n *\n * @internal\n */\nvar _closed = /*#__PURE__*/new WeakMap();\nvar _client = /*#__PURE__*/new WeakMap();\nvar _browserClient = /*#__PURE__*/new WeakMap();\nvar _forwardMessage = /*#__PURE__*/new WeakMap();\nclass CDPClientAdapter extends BidiMapper.EventEmitter {\n  constructor(client, sessionId, browserClient) {\n    super();\n    _classPrivateFieldInitSpec(this, _closed, false);\n    _classPrivateFieldInitSpec(this, _client, void 0);\n    _defineProperty(this, \"sessionId\", undefined);\n    _classPrivateFieldInitSpec(this, _browserClient, void 0);\n    _classPrivateFieldInitSpec(this, _forwardMessage, (method, event) => {\n      this.emit(method, event);\n    });\n    _classPrivateFieldSet(_client, this, client);\n    this.sessionId = sessionId;\n    _classPrivateFieldSet(_browserClient, this, browserClient);\n    _classPrivateFieldGet(_client, this).on('*', _classPrivateFieldGet(_forwardMessage, this));\n  }\n  browserClient() {\n    return _classPrivateFieldGet(_browserClient, this);\n  }\n  async sendCommand(method, ...params) {\n    if (_classPrivateFieldGet(_closed, this)) {\n      return;\n    }\n    try {\n      return await _classPrivateFieldGet(_client, this).send(method, ...params);\n    } catch (err) {\n      if (_classPrivateFieldGet(_closed, this)) {\n        return;\n      }\n      throw err;\n    }\n  }\n  close() {\n    _classPrivateFieldGet(_client, this).off('*', _classPrivateFieldGet(_forwardMessage, this));\n    _classPrivateFieldSet(_closed, this, true);\n  }\n  isCloseError(error) {\n    return error instanceof Errors_js_1.TargetCloseError;\n  }\n}\n/**\n * This transport is given to the BiDi server instance and allows Puppeteer\n * to send and receive commands to the BiDiServer.\n * @internal\n */\nvar _onMessage = /*#__PURE__*/new WeakMap();\nclass NoOpTransport extends BidiMapper.EventEmitter {\n  constructor(...args) {\n    super(...args);\n    _classPrivateFieldInitSpec(this, _onMessage, async _m => {\n      return;\n    });\n  }\n  emitMessage(message) {\n    void _classPrivateFieldGet(_onMessage, this).call(this, message);\n  }\n  setOnMessage(onMessage) {\n    _classPrivateFieldSet(_onMessage, this, onMessage);\n  }\n  async sendMessage(message) {\n    this.emit('bidiResponse', message);\n  }\n  close() {\n    _classPrivateFieldSet(_onMessage, this, async _m => {\n      return;\n    });\n  }\n}","map":{"version":3,"names":["_defineProperty","require","default","_classPrivateFieldInitSpec","_classPrivateFieldGet","_classPrivateFieldSet","BidiMapper","__importStar","Debug_js_1","Errors_js_1","Connection_js_1","bidiServerLogger","prefix","args","debug","connectBidiOverCdp","cdp","options","transportBiDi","NoOpTransport","cdpConnectionAdapter","CdpConnectionAdapter","pptrTransport","send","message","emitMessage","JSON","parse","close","bidiServer","dispose","onmessage","_message","on","stringify","pptrBiDiConnection","BidiConnection","url","delay","timeout","BidiServer","createAndStart","browserClient","undefined","exports","_cdp","WeakMap","_adapters","_browserCdpConnection","constructor","Map","CDPClientAdapter","getCdpClient","id","session","Error","has","adapter","set","get","values","_closed","_client","_browserClient","_forwardMessage","EventEmitter","client","sessionId","method","event","emit","sendCommand","params","err","off","isCloseError","error","TargetCloseError","_onMessage","_m","call","setOnMessage","onMessage","sendMessage"],"sources":["../../../../src/bidi/BidiOverCdp.ts"],"sourcesContent":[null],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"script","externalDependencies":[]}