{"ast":null,"code":"import _classPrivateMethodInitSpec from \"/Users/hexuemin/Desktop/jiuan/CGM/CGMWeb/node_modules/@babel/runtime/helpers/esm/classPrivateMethodInitSpec.js\";\nimport _defineProperty from \"/Users/hexuemin/Desktop/jiuan/CGM/CGMWeb/node_modules/@babel/runtime/helpers/esm/defineProperty.js\";\nimport _classPrivateFieldInitSpec from \"/Users/hexuemin/Desktop/jiuan/CGM/CGMWeb/node_modules/@babel/runtime/helpers/esm/classPrivateFieldInitSpec.js\";\nimport _assertClassBrand from \"/Users/hexuemin/Desktop/jiuan/CGM/CGMWeb/node_modules/@babel/runtime/helpers/esm/assertClassBrand.js\";\nimport _classPrivateFieldGet from \"/Users/hexuemin/Desktop/jiuan/CGM/CGMWeb/node_modules/@babel/runtime/helpers/esm/classPrivateFieldGet2.js\";\nimport _classPrivateFieldSet from \"/Users/hexuemin/Desktop/jiuan/CGM/CGMWeb/node_modules/@babel/runtime/helpers/esm/classPrivateFieldSet2.js\";\nimport { EventSubscription } from '../common/EventEmitter.js';\nimport { debugError } from '../common/util.js';\nimport { assert } from '../util/assert.js';\nimport { DisposableStack } from '../util/disposable.js';\n/**\n * @internal\n */\nvar _pipeWrite = /*#__PURE__*/new WeakMap();\nvar _subscriptions = /*#__PURE__*/new WeakMap();\nvar _isClosed = /*#__PURE__*/new WeakMap();\nvar _pendingMessage = /*#__PURE__*/new WeakMap();\nvar _PipeTransport_brand = /*#__PURE__*/new WeakSet();\nexport class PipeTransport {\n  constructor(pipeWrite, pipeRead) {\n    _classPrivateMethodInitSpec(this, _PipeTransport_brand);\n    _classPrivateFieldInitSpec(this, _pipeWrite, void 0);\n    _classPrivateFieldInitSpec(this, _subscriptions, new DisposableStack());\n    _classPrivateFieldInitSpec(this, _isClosed, false);\n    _classPrivateFieldInitSpec(this, _pendingMessage, '');\n    _defineProperty(this, \"onclose\", void 0);\n    _defineProperty(this, \"onmessage\", void 0);\n    _classPrivateFieldSet(_pipeWrite, this, pipeWrite);\n    _classPrivateFieldGet(_subscriptions, this).use(new EventSubscription(pipeRead, 'data', buffer => {\n      return _assertClassBrand(_PipeTransport_brand, this, _dispatch).call(this, buffer);\n    }));\n    _classPrivateFieldGet(_subscriptions, this).use(new EventSubscription(pipeRead, 'close', () => {\n      if (this.onclose) {\n        this.onclose.call(null);\n      }\n    }));\n    _classPrivateFieldGet(_subscriptions, this).use(new EventSubscription(pipeRead, 'error', debugError));\n    _classPrivateFieldGet(_subscriptions, this).use(new EventSubscription(pipeWrite, 'error', debugError));\n  }\n  send(message) {\n    assert(!_classPrivateFieldGet(_isClosed, this), '`PipeTransport` is closed.');\n    _classPrivateFieldGet(_pipeWrite, this).write(message);\n    _classPrivateFieldGet(_pipeWrite, this).write('\\0');\n  }\n  close() {\n    _classPrivateFieldSet(_isClosed, this, true);\n    _classPrivateFieldGet(_subscriptions, this).dispose();\n  }\n}\nfunction _dispatch(buffer) {\n  assert(!_classPrivateFieldGet(_isClosed, this), '`PipeTransport` is closed.');\n  let end = buffer.indexOf('\\0');\n  if (end === -1) {\n    _classPrivateFieldSet(_pendingMessage, this, _classPrivateFieldGet(_pendingMessage, this) + buffer.toString());\n    return;\n  }\n  const message = _classPrivateFieldGet(_pendingMessage, this) + buffer.toString(undefined, 0, end);\n  if (this.onmessage) {\n    this.onmessage.call(null, message);\n  }\n  let start = end + 1;\n  end = buffer.indexOf('\\0', start);\n  while (end !== -1) {\n    if (this.onmessage) {\n      this.onmessage.call(null, buffer.toString(undefined, start, end));\n    }\n    start = end + 1;\n    end = buffer.indexOf('\\0', start);\n  }\n  _classPrivateFieldSet(_pendingMessage, this, buffer.toString(undefined, start));\n}","map":{"version":3,"names":["EventSubscription","debugError","assert","DisposableStack","_pipeWrite","WeakMap","_subscriptions","_isClosed","_pendingMessage","_PipeTransport_brand","WeakSet","PipeTransport","constructor","pipeWrite","pipeRead","_classPrivateMethodInitSpec","_classPrivateFieldInitSpec","_defineProperty","_classPrivateFieldSet","_classPrivateFieldGet","use","buffer","_assertClassBrand","_dispatch","call","onclose","send","message","write","close","dispose","end","indexOf","toString","undefined","onmessage","start"],"sources":["../../../../src/node/PipeTransport.ts"],"sourcesContent":[null],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}