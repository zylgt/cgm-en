{"ast":null,"code":"import _classPrivateMethodInitSpec from \"/Users/hexuemin/Desktop/jiuan/CGM/CGMWeb/node_modules/@babel/runtime/helpers/esm/classPrivateMethodInitSpec.js\";\nimport _classPrivateFieldInitSpec from \"/Users/hexuemin/Desktop/jiuan/CGM/CGMWeb/node_modules/@babel/runtime/helpers/esm/classPrivateFieldInitSpec.js\";\nimport _assertClassBrand from \"/Users/hexuemin/Desktop/jiuan/CGM/CGMWeb/node_modules/@babel/runtime/helpers/esm/assertClassBrand.js\";\nimport _classPrivateFieldGet from \"/Users/hexuemin/Desktop/jiuan/CGM/CGMWeb/node_modules/@babel/runtime/helpers/esm/classPrivateFieldGet2.js\";\nimport _classPrivateFieldSet from \"/Users/hexuemin/Desktop/jiuan/CGM/CGMWeb/node_modules/@babel/runtime/helpers/esm/classPrivateFieldSet2.js\";\n/**\n * @license\n * Copyright 2019 Google Inc.\n * SPDX-License-Identifier: Apache-2.0\n */\nimport { firstValueFrom, map, raceWith } from '../../third_party/rxjs/rxjs.js';\nimport { Realm } from '../api/Realm.js';\nimport { EventEmitter } from '../common/EventEmitter.js';\nimport { fromEmitterEvent, withSourcePuppeteerURLIfNone } from '../common/util.js';\nimport { disposeSymbol } from '../util/disposable.js';\nimport { CdpElementHandle } from './ElementHandle.js';\nimport { CdpJSHandle } from './JSHandle.js';\n/**\n * @internal\n */\nvar _context = /*#__PURE__*/new WeakMap();\nvar _emitter = /*#__PURE__*/new WeakMap();\nvar _frameOrWorker = /*#__PURE__*/new WeakMap();\nvar _IsolatedWorld_brand = /*#__PURE__*/new WeakSet();\nexport class IsolatedWorld extends Realm {\n  constructor(frameOrWorker, timeoutSettings) {\n    super(timeoutSettings);\n    _classPrivateMethodInitSpec(this, _IsolatedWorld_brand);\n    _classPrivateFieldInitSpec(this, _context, void 0);\n    _classPrivateFieldInitSpec(this, _emitter, new EventEmitter());\n    _classPrivateFieldInitSpec(this, _frameOrWorker, void 0);\n    _classPrivateFieldSet(_frameOrWorker, this, frameOrWorker);\n  }\n  get environment() {\n    return _classPrivateFieldGet(_frameOrWorker, this);\n  }\n  get client() {\n    return _classPrivateFieldGet(_frameOrWorker, this).client;\n  }\n  get emitter() {\n    return _classPrivateFieldGet(_emitter, this);\n  }\n  setContext(context) {\n    _classPrivateFieldGet(_context, this)?.[disposeSymbol]();\n    context.once('disposed', _assertClassBrand(_IsolatedWorld_brand, this, _onContextDisposed).bind(this));\n    context.on('consoleapicalled', _assertClassBrand(_IsolatedWorld_brand, this, _onContextConsoleApiCalled).bind(this));\n    context.on('bindingcalled', _assertClassBrand(_IsolatedWorld_brand, this, _onContextBindingCalled).bind(this));\n    _classPrivateFieldSet(_context, this, context);\n    _classPrivateFieldGet(_emitter, this).emit('context', context);\n    void this.taskManager.rerunAll();\n  }\n  hasContext() {\n    return !!_classPrivateFieldGet(_context, this);\n  }\n  get context() {\n    return _classPrivateFieldGet(_context, this);\n  }\n  async evaluateHandle(pageFunction, ...args) {\n    pageFunction = withSourcePuppeteerURLIfNone(this.evaluateHandle.name, pageFunction);\n    // This code needs to schedule evaluateHandle call synchroniously (at\n    // least when the context is there) so we cannot unconditionally\n    // await.\n    let context = _assertClassBrand(_IsolatedWorld_brand, this, _executionContext).call(this);\n    if (!context) {\n      context = await _assertClassBrand(_IsolatedWorld_brand, this, _waitForExecutionContext).call(this);\n    }\n    return await context.evaluateHandle(pageFunction, ...args);\n  }\n  async evaluate(pageFunction, ...args) {\n    pageFunction = withSourcePuppeteerURLIfNone(this.evaluate.name, pageFunction);\n    // This code needs to schedule evaluate call synchroniously (at\n    // least when the context is there) so we cannot unconditionally\n    // await.\n    let context = _assertClassBrand(_IsolatedWorld_brand, this, _executionContext).call(this);\n    if (!context) {\n      context = await _assertClassBrand(_IsolatedWorld_brand, this, _waitForExecutionContext).call(this);\n    }\n    return await context.evaluate(pageFunction, ...args);\n  }\n  async adoptBackendNode(backendNodeId) {\n    // This code needs to schedule resolveNode call synchroniously (at\n    // least when the context is there) so we cannot unconditionally\n    // await.\n    let context = _assertClassBrand(_IsolatedWorld_brand, this, _executionContext).call(this);\n    if (!context) {\n      context = await _assertClassBrand(_IsolatedWorld_brand, this, _waitForExecutionContext).call(this);\n    }\n    const {\n      object\n    } = await this.client.send('DOM.resolveNode', {\n      backendNodeId: backendNodeId,\n      executionContextId: context.id\n    });\n    return this.createCdpHandle(object);\n  }\n  async adoptHandle(handle) {\n    if (handle.realm === this) {\n      // If the context has already adopted this handle, clone it so downstream\n      // disposal doesn't become an issue.\n      return await handle.evaluateHandle(value => {\n        return value;\n      });\n    }\n    const nodeInfo = await this.client.send('DOM.describeNode', {\n      objectId: handle.id\n    });\n    return await this.adoptBackendNode(nodeInfo.node.backendNodeId);\n  }\n  async transferHandle(handle) {\n    if (handle.realm === this) {\n      return handle;\n    }\n    // Implies it's a primitive value, probably.\n    if (handle.remoteObject().objectId === undefined) {\n      return handle;\n    }\n    const info = await this.client.send('DOM.describeNode', {\n      objectId: handle.remoteObject().objectId\n    });\n    const newHandle = await this.adoptBackendNode(info.node.backendNodeId);\n    await handle.dispose();\n    return newHandle;\n  }\n  /**\n   * @internal\n   */\n  createCdpHandle(remoteObject) {\n    if (remoteObject.subtype === 'node') {\n      return new CdpElementHandle(this, remoteObject);\n    }\n    return new CdpJSHandle(this, remoteObject);\n  }\n  [disposeSymbol]() {\n    _classPrivateFieldGet(_context, this)?.[disposeSymbol]();\n    _classPrivateFieldGet(_emitter, this).emit('disposed', undefined);\n    super[disposeSymbol]();\n    _classPrivateFieldGet(_emitter, this).removeAllListeners();\n  }\n}\nfunction _onContextDisposed() {\n  _classPrivateFieldSet(_context, this, undefined);\n  if ('clearDocumentHandle' in _classPrivateFieldGet(_frameOrWorker, this)) {\n    _classPrivateFieldGet(_frameOrWorker, this).clearDocumentHandle();\n  }\n}\nfunction _onContextConsoleApiCalled(event) {\n  _classPrivateFieldGet(_emitter, this).emit('consoleapicalled', event);\n}\nfunction _onContextBindingCalled(event) {\n  _classPrivateFieldGet(_emitter, this).emit('bindingcalled', event);\n}\nfunction _executionContext() {\n  if (this.disposed) {\n    throw new Error(`Execution context is not available in detached frame or worker \"${this.environment.url()}\" (are you trying to evaluate?)`);\n  }\n  return _classPrivateFieldGet(_context, this);\n}\n/**\n * Waits for the next context to be set on the isolated world.\n */\nasync function _waitForExecutionContext() {\n  const result = await firstValueFrom(fromEmitterEvent(_classPrivateFieldGet(_emitter, this), 'context').pipe(raceWith(fromEmitterEvent(_classPrivateFieldGet(_emitter, this), 'disposed').pipe(map(() => {\n    // The message has to match the CDP message expected by the WaitTask class.\n    throw new Error('Execution context was destroyed');\n  })))));\n  return result;\n}","map":{"version":3,"names":["firstValueFrom","map","raceWith","Realm","EventEmitter","fromEmitterEvent","withSourcePuppeteerURLIfNone","disposeSymbol","CdpElementHandle","CdpJSHandle","_context","WeakMap","_emitter","_frameOrWorker","_IsolatedWorld_brand","WeakSet","IsolatedWorld","constructor","frameOrWorker","timeoutSettings","_classPrivateMethodInitSpec","_classPrivateFieldInitSpec","_classPrivateFieldSet","environment","_classPrivateFieldGet","client","emitter","setContext","context","once","_assertClassBrand","_onContextDisposed","bind","on","_onContextConsoleApiCalled","_onContextBindingCalled","emit","taskManager","rerunAll","hasContext","evaluateHandle","pageFunction","args","name","_executionContext","call","_waitForExecutionContext","evaluate","adoptBackendNode","backendNodeId","object","send","executionContextId","id","createCdpHandle","adoptHandle","handle","realm","value","nodeInfo","objectId","node","transferHandle","remoteObject","undefined","info","newHandle","dispose","subtype","removeAllListeners","clearDocumentHandle","event","disposed","Error","url","result","pipe"],"sources":["../../../../src/cdp/IsolatedWorld.ts"],"sourcesContent":[null],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}