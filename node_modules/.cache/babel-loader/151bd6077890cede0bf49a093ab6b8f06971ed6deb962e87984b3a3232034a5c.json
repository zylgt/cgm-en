{"ast":null,"code":"import { TIRUtils } from \"@/utils/algorithm/TIR\";\nimport { formatDate, formatTime } from '@/utils/formatTime';\nimport Worker from \"worker-loader!@/workers/tir_worker\";\nexport default {\n  name: 'TIR',\n  data() {\n    return {\n      levels: [{\n        key: '2 级高血糖',\n        value: 15,\n        color: '#E98C41',\n        desc: '>13.9mmol/L'\n      }, {\n        key: '1 级高血糖',\n        value: 25,\n        color: '#F6C059',\n        desc: '5.1-13.9mmol/L'\n      }, {\n        key: '目标范围内',\n        value: 58,\n        color: '#32BAC0',\n        desc: '3.9~10.0mmol/L'\n      }, {\n        key: '1 级低血糖',\n        value: 1,\n        color: '#F43F31',\n        desc: '3.0~3.8mmol/L'\n      }, {\n        key: '2 级低血糖',\n        value: 1,\n        color: '#96251C',\n        desc: '<3.0mmol/L'\n      }],\n      worker: null\n    };\n  },\n  created() {\n    this.worker = new Worker();\n    this.$bus.$on('getData', data => {\n      console.log(formatTime(new Date()), '发送数据');\n      this.worker.postMessage(data);\n    });\n    this.worker.onmessage = e => {\n      console.log(formatTime(new Date()), '得到数据');\n      this.levels[0].value = e.data.veryHighRate * 100;\n      this.levels[1].value = e.data.highRate * 100;\n      this.levels[2].value = e.data.normalRate * 100;\n      this.levels[3].value = e.data.lowRate * 100;\n      this.levels[4].value = e.data.veryLowRate * 100;\n      this.drawTir();\n    };\n  },\n  mounted() {\n    // this.drawTir()\n    // this.$bus.$on('getData',(data)=>{\n    //     console.log(formatTime(new Date()))\n    //     let result = TIRUtils.getTIRResult(_.map(data, 'Value'))\n    //     this.levels[0].value = result.veryHighRate*100\n    //     this.levels[1].value = result.highRate*100\n    //     this.levels[2].value = result.normalRate*100\n    //     this.levels[3].value = result.lowRate*100\n    //     this.levels[4].value = result.veryLowRate*100\n    //     this.drawTir()\n    // })\n  },\n  methods: {\n    drawTir() {\n      const canvas = document.getElementById(\"myCanvas\");\n      const ctx = canvas.getContext(\"2d\");\n      const W = this.$refs.tir.offsetWidth * 2;\n      const H = this.$refs.tir.offsetHeight * 2;\n      canvas.width = W;\n      canvas.height = H;\n      ctx.scale(2, 2);\n      const barW = 40; //柱状图宽度\n      const splitInterval = 1; //间隔距离\n      const lineStart = barW + 5; //标识线x轴起点\n      const lineWidth = 15; //标识线x轴起点\n      let start_y = 10; //柱状图y轴起始点 \n      let labelLineIndex = 0; //标识线是否要弯折\n      for (var i = 0; i < this.levels.length; i++) {\n        let value = Number(this.levels[i].value) * 2;\n\n        // 画柱\n        ctx.fillStyle = this.levels[i].color;\n        ctx.fillRect(0, start_y, barW, value);\n        start_y = start_y + value + splitInterval;\n\n        // if(value<21){\n        //     labelLineIndex++\n        // }else if(value>30) {\n        //     labelLineIndex = 0\n        // }\n        // let  lineOneX =value>20 ? lineStart+lineWidth : lineStart+(lineWidth-labelLineIndex*3)\n        // let  lineOneY = start_y-(value/2)\n        // let  lineTwoX = lineOneX\n        // let  lineTwoY = labelLineIndex>1&&this.levels[i].value<=20?start_y-(value/2)+labelLineIndex*35:lineOneY\n\n        console.log(value);\n        if (value < 31) {\n          labelLineIndex++;\n        } else if (value > 40) {\n          labelLineIndex = 0;\n        }\n        let lineOneX = value > 30 ? lineStart + lineWidth : lineStart + (lineWidth - labelLineIndex * 3);\n        let lineOneY = start_y - value / 2;\n        let lineTwoX = lineOneX;\n        let lineTwoY = labelLineIndex > 1 && this.levels[i].value <= 30 ? start_y - value / 2 + labelLineIndex * 35 : lineOneY;\n        // if(i>2&&this.levels[i].value<30&&labelLineIndex>1){\n        //     lineTwoY = start_y-(value/2)+labelLineIndex*40\n        // }\n        let lineThreeX = lineWidth + lineStart;\n        let lineThreeY = lineTwoY;\n        if (value > 0) {\n          // 标识线\n          ctx.lineWidth = \"1\";\n          ctx.strokeStyle = \"#e5e5e5\";\n          ctx.moveTo(lineStart, start_y - value / 2);\n          ctx.lineTo(lineOneX, lineOneY);\n          ctx.lineTo(lineTwoX, lineTwoY);\n          ctx.lineTo(lineThreeX, lineThreeY);\n          ctx.stroke();\n\n          // lengeng\n          ctx.fillRect(lineThreeX + 5, lineThreeY - 4, 8, 8);\n\n          // key\n          ctx.font = \"16px Arial\";\n          ctx.fillStyle = '#333';\n          ctx.fillText(this.levels[i].key, lineThreeX + 20, lineThreeY + 5);\n\n          // 目标范围\n          ctx.font = \"13px Arial\";\n          ctx.fillStyle = '#999';\n          ctx.fillText(this.levels[i].desc, lineThreeX + 30, lineThreeY + 25);\n\n          // value值\n          const textWidth = ctx.measureText(this.levels[i].key).width;\n          ctx.font = \"16px Arial\";\n          ctx.fillStyle = '#000';\n          ctx.fillText(this.levels[i].value, lineThreeX + 40 + textWidth, lineThreeY + 5);\n\n          // 百分号\n          const valueWidth = ctx.measureText(this.levels[i].value).width;\n          ctx.fillStyle = '#666';\n          ctx.fillText('%', lineThreeX + 42 + textWidth + valueWidth, lineThreeY + 5);\n\n          // 范围\n          const descWidth = ctx.measureText(this.levels[i].desc).width;\n          ctx.fillText(this.levels[i].desc, W / 2 - descWidth - 10, lineThreeY + 5);\n        }\n      }\n      this.$nextTick(() => {\n        console.log(formatTime(new Date()), '渲染完成');\n      });\n    }\n  },\n  beforeDestroy() {\n    this.$bus.$off('getData');\n    this.worker.terminate();\n  }\n};","map":{"version":3,"names":["TIRUtils","formatDate","formatTime","Worker","name","data","levels","key","value","color","desc","worker","created","$bus","$on","console","log","Date","postMessage","onmessage","e","veryHighRate","highRate","normalRate","lowRate","veryLowRate","drawTir","mounted","methods","canvas","document","getElementById","ctx","getContext","W","$refs","tir","offsetWidth","H","offsetHeight","width","height","scale","barW","splitInterval","lineStart","lineWidth","start_y","labelLineIndex","i","length","Number","fillStyle","fillRect","lineOneX","lineOneY","lineTwoX","lineTwoY","lineThreeX","lineThreeY","strokeStyle","moveTo","lineTo","stroke","font","fillText","textWidth","measureText","valueWidth","descWidth","$nextTick","beforeDestroy","$off","terminate"],"sources":["src/views/components/Chart/TIR.vue"],"sourcesContent":["<template>\n    <div class='TIR' ref='tir'>\n        <canvas id='myCanvas' ref='canvas' class='canvas' ></canvas>\n    </div>\n</template>\n<script>\nimport { TIRUtils } from \"@/utils/algorithm/TIR\";\nimport {formatDate,formatTime} from '@/utils/formatTime'\nimport Worker from \"worker-loader!@/workers/tir_worker\"\nexport default {\n    name:'TIR',\n    data(){\n        return{\n            levels: [\n                {key: '2 级高血糖', value: 15, color: '#E98C41', desc: '>13.9mmol/L'},\n                {\n                    key: '1 级高血糖',\n                    value: 25,\n                    color: '#F6C059',\n                    desc: '5.1-13.9mmol/L',\n                },\n                {\n                    key: '目标范围内',\n                    value: 58,\n                    color: '#32BAC0',\n                    desc: '3.9~10.0mmol/L',\n                },\n                {key: '1 级低血糖', value: 1, color: '#F43F31', desc: '3.0~3.8mmol/L'},\n                {key: '2 级低血糖', value:1, color: '#96251C', desc: '<3.0mmol/L'},\n            ],\n            worker: null,\n        }\n    },\n    created(){\n        this.worker = new Worker()\n        this.$bus.$on('getData',(data)=>{\n            console.log(formatTime(new Date()),'发送数据')\n            this.worker.postMessage(data)\n        })\n        this.worker.onmessage = (e) =>{\n            console.log(formatTime(new Date()),'得到数据')\n            this.levels[0].value = e.data.veryHighRate*100\n            this.levels[1].value = e.data.highRate*100\n            this.levels[2].value = e.data.normalRate*100\n            this.levels[3].value = e.data.lowRate*100\n            this.levels[4].value = e.data.veryLowRate*100\n            this.drawTir()\n           \n        }\n    },\n    mounted(){\n        // this.drawTir()\n        // this.$bus.$on('getData',(data)=>{\n        //     console.log(formatTime(new Date()))\n        //     let result = TIRUtils.getTIRResult(_.map(data, 'Value'))\n        //     this.levels[0].value = result.veryHighRate*100\n        //     this.levels[1].value = result.highRate*100\n        //     this.levels[2].value = result.normalRate*100\n        //     this.levels[3].value = result.lowRate*100\n        //     this.levels[4].value = result.veryLowRate*100\n        //     this.drawTir()\n        // })\n    },\n    methods:{\n        drawTir(){\n            const canvas = document.getElementById(\"myCanvas\");\n            const ctx = canvas.getContext(\"2d\")\n            const W = this.$refs.tir.offsetWidth*2\n            const H = this.$refs.tir.offsetHeight*2\n            canvas.width = W\n            canvas.height = H\n            ctx.scale(2, 2)\n            const barW = 40 //柱状图宽度\n            const splitInterval = 1 //间隔距离\n            const lineStart = barW+5 //标识线x轴起点\n            const lineWidth =15//标识线x轴起点\n            let  start_y = 10 //柱状图y轴起始点 \n            let labelLineIndex = 0 //标识线是否要弯折\n            for(var i=0;i<this.levels.length;i++){\n                let value = Number(this.levels[i].value)*2\n\n                // 画柱\n                ctx.fillStyle = this.levels[i].color\n                ctx.fillRect(0,start_y,barW,value)\n                start_y = start_y + value + splitInterval\n\n                \n                \n                // if(value<21){\n                //     labelLineIndex++\n                // }else if(value>30) {\n                //     labelLineIndex = 0\n                // }\n                // let  lineOneX =value>20 ? lineStart+lineWidth : lineStart+(lineWidth-labelLineIndex*3)\n                // let  lineOneY = start_y-(value/2)\n                // let  lineTwoX = lineOneX\n                // let  lineTwoY = labelLineIndex>1&&this.levels[i].value<=20?start_y-(value/2)+labelLineIndex*35:lineOneY\n\n                console.log(value)\n                if(value<31){\n                    labelLineIndex++\n                }else if(value>40) {\n                    labelLineIndex = 0\n                }\n                let  lineOneX =value>30 ? lineStart+lineWidth : lineStart+(lineWidth-labelLineIndex*3)\n                let  lineOneY = start_y-(value/2)\n                let  lineTwoX = lineOneX\n                let  lineTwoY = labelLineIndex>1&&this.levels[i].value<=30?start_y-(value/2)+labelLineIndex*35:lineOneY\n                // if(i>2&&this.levels[i].value<30&&labelLineIndex>1){\n                //     lineTwoY = start_y-(value/2)+labelLineIndex*40\n                // }\n                let  lineThreeX = lineWidth+lineStart\n                let  lineThreeY = lineTwoY\n                \n                if(value>0){\n                    // 标识线\n                    ctx.lineWidth=\"1\";\n                    ctx.strokeStyle=\"#e5e5e5\";\n                    ctx.moveTo(lineStart,start_y-(value/2));\n                    ctx.lineTo(lineOneX,lineOneY);\n                    ctx.lineTo(lineTwoX,lineTwoY);\n                    ctx.lineTo(lineThreeX,lineThreeY);\n                    ctx.stroke();\n\n                    // lengeng\n                    ctx.fillRect(lineThreeX+5,lineThreeY-4,8,8)\n                    \n                    // key\n                    ctx.font=\"16px Arial\";\n                    ctx.fillStyle = '#333'\n                    ctx.fillText(this.levels[i].key,lineThreeX+20,lineThreeY+5);\n\n                    // 目标范围\n                    ctx.font=\"13px Arial\";\n                    ctx.fillStyle = '#999'\n                    ctx.fillText(this.levels[i].desc,lineThreeX+30,lineThreeY+25);\n\n\n\n                    // value值\n                    const textWidth= ctx.measureText(this.levels[i].key).width;\n                    ctx.font=\"16px Arial\";\n                    ctx.fillStyle = '#000'\n                    ctx.fillText(this.levels[i].value,lineThreeX+40+textWidth,lineThreeY+5);\n\n                    // 百分号\n                    const valueWidth= ctx.measureText(this.levels[i].value).width;\n                    ctx.fillStyle = '#666'\n                    ctx.fillText('%',lineThreeX+42+textWidth+valueWidth,lineThreeY+5);\n\n                    // 范围\n                    const descWidth = ctx.measureText(this.levels[i].desc).width;\n                    ctx.fillText(this.levels[i].desc,W/2-descWidth-10,lineThreeY+5)\n                }\n                \n            }\n           this.$nextTick(()=>{\n                console.log(formatTime(new Date()),'渲染完成')\n            })\n        },\n    },\n    beforeDestroy(){\n        this.$bus.$off('getData')\n        this.worker.terminate()\n    }\n}\n</script>\n<style scoped>\n    .TIR{\n        height:380px;\n    }\n    .canvas{\n        height:380px;\n    }\n</style>"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}