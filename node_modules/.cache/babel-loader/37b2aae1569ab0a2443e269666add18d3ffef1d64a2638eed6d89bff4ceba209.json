{"ast":null,"code":"/**\n * @license\n * Copyright 2023 Google Inc.\n * SPDX-License-Identifier: Apache-2.0\n */\nimport { Connection } from '../cdp/Connection.js';\nimport { ProtocolError, UnsupportedOperation } from '../common/Errors.js';\nimport { debugError, DEFAULT_VIEWPORT } from '../common/util.js';\n/**\n * Users should never call this directly; it's called when calling `puppeteer.connect`\n * with `protocol: 'webDriverBiDi'`. This method attaches Puppeteer to an existing browser\n * instance. First it tries to connect to the browser using pure BiDi. If the protocol is\n * not supported, connects to the browser using BiDi over CDP.\n *\n * @internal\n */\nexport async function _connectToBiDiBrowser(connectionTransport, url, options) {\n  const {\n    ignoreHTTPSErrors = false,\n    defaultViewport = DEFAULT_VIEWPORT\n  } = options;\n  const {\n    bidiConnection,\n    closeCallback\n  } = await getBiDiConnection(connectionTransport, url, options);\n  const BiDi = await import( /* webpackIgnore: true */'./bidi.js');\n  const bidiBrowser = await BiDi.BidiBrowser.create({\n    connection: bidiConnection,\n    closeCallback,\n    process: undefined,\n    defaultViewport: defaultViewport,\n    ignoreHTTPSErrors: ignoreHTTPSErrors\n  });\n  return bidiBrowser;\n}\n/**\n * Returns a BiDiConnection established to the endpoint specified by the options and a\n * callback closing the browser. Callback depends on whether the connection is pure BiDi\n * or BiDi over CDP.\n * The method tries to connect to the browser using pure BiDi protocol, and falls back\n * to BiDi over CDP.\n */\nasync function getBiDiConnection(connectionTransport, url, options) {\n  const BiDi = await import( /* webpackIgnore: true */'./bidi.js');\n  const {\n    ignoreHTTPSErrors = false,\n    slowMo = 0,\n    protocolTimeout\n  } = options;\n  // Try pure BiDi first.\n  const pureBidiConnection = new BiDi.BidiConnection(url, connectionTransport, slowMo, protocolTimeout);\n  try {\n    const result = await pureBidiConnection.send('session.status', {});\n    if ('type' in result && result.type === 'success') {\n      // The `browserWSEndpoint` points to an endpoint supporting pure WebDriver BiDi.\n      return {\n        bidiConnection: pureBidiConnection,\n        closeCallback: async () => {\n          await pureBidiConnection.send('browser.close', {}).catch(debugError);\n        }\n      };\n    }\n  } catch (e) {\n    if (!(e instanceof ProtocolError)) {\n      // Unexpected exception not related to BiDi / CDP. Rethrow.\n      throw e;\n    }\n  }\n  // Unbind the connection to avoid memory leaks.\n  pureBidiConnection.unbind();\n  // Fall back to CDP over BiDi reusing the WS connection.\n  const cdpConnection = new Connection(url, connectionTransport, slowMo, protocolTimeout);\n  const version = await cdpConnection.send('Browser.getVersion');\n  if (version.product.toLowerCase().includes('firefox')) {\n    throw new UnsupportedOperation('Firefox is not supported in BiDi over CDP mode.');\n  }\n  // TODO: use other options too.\n  const bidiOverCdpConnection = await BiDi.connectBidiOverCdp(cdpConnection, {\n    acceptInsecureCerts: ignoreHTTPSErrors\n  });\n  return {\n    bidiConnection: bidiOverCdpConnection,\n    closeCallback: async () => {\n      // In case of BiDi over CDP, we need to close browser via CDP.\n      await cdpConnection.send('Browser.close').catch(debugError);\n    }\n  };\n}","map":{"version":3,"names":["Connection","ProtocolError","UnsupportedOperation","debugError","DEFAULT_VIEWPORT","_connectToBiDiBrowser","connectionTransport","url","options","ignoreHTTPSErrors","defaultViewport","bidiConnection","closeCallback","getBiDiConnection","BiDi","bidiBrowser","BidiBrowser","create","connection","process","undefined","slowMo","protocolTimeout","pureBidiConnection","BidiConnection","result","send","type","catch","e","unbind","cdpConnection","version","product","toLowerCase","includes","bidiOverCdpConnection","connectBidiOverCdp","acceptInsecureCerts"],"sources":["../../../../src/bidi/BrowserConnector.ts"],"sourcesContent":[null],"mappings":"AAAA;;;;;AAOA,SAAQA,UAAU,QAAO,sBAAsB;AAM/C,SAAQC,aAAa,EAAEC,oBAAoB,QAAO,qBAAqB;AACvE,SAAQC,UAAU,EAAEC,gBAAgB,QAAO,mBAAmB;AAK9D;;;;;;;;AAQA,OAAO,eAAeC,qBAAqBA,CACzCC,mBAAwC,EACxCC,GAAW,EACXC,OAA+C;EAE/C,MAAM;IAACC,iBAAiB,GAAG,KAAK;IAAEC,eAAe,GAAGN;EAAgB,CAAC,GACnEI,OAAO;EAET,MAAM;IAACG,cAAc;IAAEC;EAAa,CAAC,GAAG,MAAMC,iBAAiB,CAC7DP,mBAAmB,EACnBC,GAAG,EACHC,OAAO,CACR;EACD,MAAMM,IAAI,GAAG,MAAM,MAAM,EAAC,yBAA0B,WAAW,CAAC;EAChE,MAAMC,WAAW,GAAG,MAAMD,IAAI,CAACE,WAAW,CAACC,MAAM,CAAC;IAChDC,UAAU,EAAEP,cAAc;IAC1BC,aAAa;IACbO,OAAO,EAAEC,SAAS;IAClBV,eAAe,EAAEA,eAAe;IAChCD,iBAAiB,EAAEA;GACpB,CAAC;EACF,OAAOM,WAAW;AACpB;AAEA;;;;;;;AAOA,eAAeF,iBAAiBA,CAC9BP,mBAAwC,EACxCC,GAAW,EACXC,OAA8B;EAK9B,MAAMM,IAAI,GAAG,MAAM,MAAM,EAAC,yBAA0B,WAAW,CAAC;EAChE,MAAM;IAACL,iBAAiB,GAAG,KAAK;IAAEY,MAAM,GAAG,CAAC;IAAEC;EAAe,CAAC,GAAGd,OAAO;EAExE;EACA,MAAMe,kBAAkB,GAAG,IAAIT,IAAI,CAACU,cAAc,CAChDjB,GAAG,EACHD,mBAAmB,EACnBe,MAAM,EACNC,eAAe,CAChB;EACD,IAAI;IACF,MAAMG,MAAM,GAAG,MAAMF,kBAAkB,CAACG,IAAI,CAAC,gBAAgB,EAAE,EAAE,CAAC;IAClE,IAAI,MAAM,IAAID,MAAM,IAAIA,MAAM,CAACE,IAAI,KAAK,SAAS,EAAE;MACjD;MACA,OAAO;QACLhB,cAAc,EAAEY,kBAAkB;QAClCX,aAAa,EAAE,MAAAA,CAAA,KAAW;UACxB,MAAMW,kBAAkB,CAACG,IAAI,CAAC,eAAe,EAAE,EAAE,CAAC,CAACE,KAAK,CAACzB,UAAU,CAAC;QACtE;OACD;IACH;EACF,CAAC,CAAC,OAAO0B,CAAC,EAAE;IACV,IAAI,EAAEA,CAAC,YAAY5B,aAAa,CAAC,EAAE;MACjC;MACA,MAAM4B,CAAC;IACT;EACF;EACA;EACAN,kBAAkB,CAACO,MAAM,EAAE;EAE3B;EACA,MAAMC,aAAa,GAAG,IAAI/B,UAAU,CAClCO,GAAG,EACHD,mBAAmB,EACnBe,MAAM,EACNC,eAAe,CAChB;EAED,MAAMU,OAAO,GAAG,MAAMD,aAAa,CAACL,IAAI,CAAC,oBAAoB,CAAC;EAC9D,IAAIM,OAAO,CAACC,OAAO,CAACC,WAAW,EAAE,CAACC,QAAQ,CAAC,SAAS,CAAC,EAAE;IACrD,MAAM,IAAIjC,oBAAoB,CAC5B,iDAAiD,CAClD;EACH;EAEA;EACA,MAAMkC,qBAAqB,GAAG,MAAMtB,IAAI,CAACuB,kBAAkB,CAACN,aAAa,EAAE;IACzEO,mBAAmB,EAAE7B;GACtB,CAAC;EACF,OAAO;IACLE,cAAc,EAAEyB,qBAAqB;IACrCxB,aAAa,EAAE,MAAAA,CAAA,KAAW;MACxB;MACA,MAAMmB,aAAa,CAACL,IAAI,CAAC,eAAe,CAAC,CAACE,KAAK,CAACzB,UAAU,CAAC;IAC7D;GACD;AACH","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}